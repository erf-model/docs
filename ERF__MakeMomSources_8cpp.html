<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ERF: Source/SourceTerms/ERF_MakeMomSources.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ERF
   </div>
   <div id="projectbrief">Energy Research and Forecasting: An Atmospheric Modeling Code</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('ERF__MakeMomSources_8cpp.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">ERF_MakeMomSources.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;AMReX_MultiFab.H&gt;</code><br />
<code>#include &lt;AMReX_ArrayLim.H&gt;</code><br />
<code>#include &lt;AMReX_BCRec.H&gt;</code><br />
<code>#include &lt;AMReX_TableData.H&gt;</code><br />
<code>#include &lt;AMReX_GpuContainers.H&gt;</code><br />
<code>#include &quot;<a class="el" href="ERF__NumericalDiffusion_8H_source.html">ERF_NumericalDiffusion.H</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="ERF__PlaneAverage_8H_source.html">ERF_PlaneAverage.H</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="ERF__TI__slow__headers_8H_source.html">ERF_TI_slow_headers.H</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="ERF__SrcHeaders_8H_source.html">ERF_SrcHeaders.H</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="ERF__Utils_8H_source.html">ERF_Utils.H</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for ERF_MakeMomSources.cpp:</div>
<div class="dyncontent">
<div class="center"><img src="ERF__MakeMomSources_8cpp__incl.png" border="0" usemap="#aSource_2SourceTerms_2ERF__MakeMomSources_8cpp" alt=""/></div>
<map name="aSource_2SourceTerms_2ERF__MakeMomSources_8cpp" id="aSource_2SourceTerms_2ERF__MakeMomSources_8cpp">
<area shape="rect" title=" " alt="" coords="1851,5,2055,47"/>
<area shape="rect" title=" " alt="" coords="1843,468,1988,495"/>
<area shape="rect" title=" " alt="" coords="195,95,345,121"/>
<area shape="rect" title=" " alt="" coords="1989,244,2121,271"/>
<area shape="rect" title=" " alt="" coords="1583,95,1738,121"/>
<area shape="rect" title=" " alt="" coords="79,393,266,420"/>
<area shape="rect" href="ERF__NumericalDiffusion_8H.html" title=" " alt="" coords="3083,319,3276,345"/>
<area shape="rect" href="ERF__PlaneAverage_8H.html" title=" " alt="" coords="630,319,787,345"/>
<area shape="rect" href="ERF__TI__slow__headers_8H.html" title=" " alt="" coords="1762,95,1938,121"/>
<area shape="rect" href="ERF__SrcHeaders_8H.html" title=" " alt="" coords="2923,169,3065,196"/>
<area shape="rect" href="ERF__Utils_8H.html" title=" " alt="" coords="2407,169,2506,196"/>
<area shape="rect" title=" " alt="" coords="2526,617,2609,644"/>
<area shape="rect" href="ERF__DataStruct_8H.html" title=" " alt="" coords="2727,393,2864,420"/>
<area shape="rect" title=" " alt="" coords="2837,543,2895,569"/>
<area shape="rect" title=" " alt="" coords="3071,543,3151,569"/>
<area shape="rect" title=" " alt="" coords="2579,543,2737,569"/>
<area shape="rect" title=" " alt="" coords="2923,543,3043,569"/>
<area shape="rect" title=" " alt="" coords="2273,543,2389,569"/>
<area shape="rect" title=" " alt="" coords="2023,543,2176,569"/>
<area shape="rect" href="ERF__Constants_8H.html" title=" " alt="" coords="294,543,427,569"/>
<area shape="rect" href="ERF__IndexDefines_8H.html" title=" " alt="" coords="665,543,819,569"/>
<area shape="rect" href="ERF__AdvStruct_8H.html" title=" " alt="" coords="2266,468,2397,495"/>
<area shape="rect" href="ERF__DampingStruct_8H.html" title=" " alt="" coords="3229,468,3394,495"/>
<area shape="rect" href="ERF__DiffStruct_8H.html" title=" " alt="" coords="2896,468,3025,495"/>
<area shape="rect" href="ERF__SpongeStruct_8H.html" title=" " alt="" coords="3050,468,3205,495"/>
<area shape="rect" href="ERF__TurbStruct_8H.html" title=" " alt="" coords="2421,468,2554,495"/>
<area shape="rect" href="ERF__TurbPertStruct_8H.html" title=" " alt="" coords="3520,468,3679,495"/>
<area shape="rect" title=" " alt="" coords="299,617,422,644"/>
<area shape="rect" title=" " alt="" coords="678,617,806,644"/>
<area shape="rect" href="ERF__TileNoZ_8H.html" title=" " alt="" coords="3575,543,3693,569"/>
<area shape="rect" title=" " alt="" coords="949,393,1098,420"/>
<area shape="rect" href="ERF__DirectionSelector_8H.html" title=" " alt="" coords="594,393,773,420"/>
<area shape="rect" title=" " alt="" coords="661,468,775,495"/>
<area shape="rect" title=" " alt="" coords="459,244,646,271"/>
<area shape="rect" title=" " alt="" coords="1089,169,1256,196"/>
<area shape="rect" title=" " alt="" coords="2771,244,2956,271"/>
<area shape="rect" href="ERF__SurfaceLayer_8H.html" title=" " alt="" coords="1287,244,1439,271"/>
<area shape="rect" href="ERF__TerrainMetrics_8H.html" title=" " alt="" coords="1455,393,1615,420"/>
<area shape="rect" href="ERF__Advection_8H.html" title=" " alt="" coords="1513,169,1646,196"/>
<area shape="rect" href="ERF__EB_8H.html" title=" " alt="" coords="2146,244,2231,271"/>
<area shape="rect" href="ERF__Diffusion_8H.html" title=" " alt="" coords="1787,169,1913,196"/>
<area shape="rect" href="ERF__EddyViscosity_8H.html" title=" " alt="" coords="1331,169,1489,196"/>
<area shape="rect" title=" " alt="" coords="1123,393,1279,420"/>
<area shape="rect" title=" " alt="" coords="1043,319,1228,345"/>
<area shape="rect" href="ERF__MOSTAverage_8H.html" title=" " alt="" coords="1456,319,1615,345"/>
<area shape="rect" href="ERF__MOSTStress_8H.html" title=" " alt="" coords="287,468,434,495"/>
<area shape="rect" href="ERF__PBLHeight_8H.html" title=" " alt="" coords="1893,319,2028,345"/>
<area shape="rect" href="ERF__MicrophysicsUtils_8H.html" title=" " alt="" coords="29,468,212,495"/>
<area shape="rect" href="ERF__InputSoundingData_8H.html" title=" " alt="" coords="2629,468,2821,495"/>
<area shape="rect" href="ERF__FillPatcher_8H.html" title=" " alt="" coords="2459,244,2593,271"/>
</map>
</div>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a4cd65257808dd22bb20701e18a9efdcd"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ERF__MakeMomSources_8cpp.html#a4cd65257808dd22bb20701e18a9efdcd">make_mom_sources</a> (<a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> time, <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> dt, const Vector&lt; MultiFab &gt; &amp;S_data, MultiFab &amp;z_phys_nd, MultiFab &amp;z_phys_cc, Vector&lt; <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> &gt; &amp;stretched_dz_h, const MultiFab &amp;xvel, const MultiFab &amp;yvel, const MultiFab &amp;wvel, MultiFab &amp;xmom_src, MultiFab &amp;ymom_src, MultiFab &amp;zmom_src, const MultiFab &amp;base_state, MultiFab *forest_drag, MultiFab *terrain_blank, MultiFab *cosPhi_mf, MultiFab *sinPhi_mf, const Geometry geom, const <a class="el" href="structSolverChoice.html">SolverChoice</a> &amp;solverChoice, Vector&lt; std::unique_ptr&lt; MultiFab &gt;&gt; &amp;, const <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> *dptr_u_geos, const <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> *dptr_v_geos, const <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> *dptr_wbar_sub, const Vector&lt; <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> * &gt; d_rayleigh_ptrs_at_lev, const <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">amrex::Real</a> *d_sinesq_at_lev, const <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">amrex::Real</a> *d_sinesq_stag_at_lev, const Vector&lt; <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> * &gt; d_sponge_ptrs_at_lev, const Vector&lt; MultiFab &gt; *forecast_state_at_lev, <a class="el" href="structInputSoundingData.html">InputSoundingData</a> &amp;input_sounding_data, bool is_slow_step)</td></tr>
<tr class="separator:a4cd65257808dd22bb20701e18a9efdcd"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a4cd65257808dd22bb20701e18a9efdcd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4cd65257808dd22bb20701e18a9efdcd">&#9670;&nbsp;</a></span>make_mom_sources()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void make_mom_sources </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>&#160;</td>
          <td class="paramname"><em>time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Vector&lt; MultiFab &gt; &amp;&#160;</td>
          <td class="paramname"><em>S_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">MultiFab &amp;&#160;</td>
          <td class="paramname"><em>z_phys_nd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">MultiFab &amp;&#160;</td>
          <td class="paramname"><em>z_phys_cc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Vector&lt; <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>stretched_dz_h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const MultiFab &amp;&#160;</td>
          <td class="paramname"><em>xvel</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const MultiFab &amp;&#160;</td>
          <td class="paramname"><em>yvel</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const MultiFab &amp;&#160;</td>
          <td class="paramname"><em>wvel</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">MultiFab &amp;&#160;</td>
          <td class="paramname"><em>xmom_src</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">MultiFab &amp;&#160;</td>
          <td class="paramname"><em>ymom_src</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">MultiFab &amp;&#160;</td>
          <td class="paramname"><em>zmom_src</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const MultiFab &amp;&#160;</td>
          <td class="paramname"><em>base_state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">MultiFab *&#160;</td>
          <td class="paramname"><em>forest_drag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">MultiFab *&#160;</td>
          <td class="paramname"><em>terrain_blank</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">MultiFab *&#160;</td>
          <td class="paramname"><em>cosPhi_mf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">MultiFab *&#160;</td>
          <td class="paramname"><em>sinPhi_mf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Geometry&#160;</td>
          <td class="paramname"><em>geom</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structSolverChoice.html">SolverChoice</a> &amp;&#160;</td>
          <td class="paramname"><em>solverChoice</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Vector&lt; std::unique_ptr&lt; MultiFab &gt;&gt; &amp;&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> *&#160;</td>
          <td class="paramname"><em>dptr_u_geos</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> *&#160;</td>
          <td class="paramname"><em>dptr_v_geos</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> *&#160;</td>
          <td class="paramname"><em>dptr_wbar_sub</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Vector&lt; <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> * &gt;&#160;</td>
          <td class="paramname"><em>d_rayleigh_ptrs_at_lev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">amrex::Real</a> *&#160;</td>
          <td class="paramname"><em>d_sinesq_at_lev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">amrex::Real</a> *&#160;</td>
          <td class="paramname"><em>d_sinesq_stag_at_lev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Vector&lt; <a class="el" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> * &gt;&#160;</td>
          <td class="paramname"><em>d_sponge_ptrs_at_lev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Vector&lt; MultiFab &gt; *&#160;</td>
          <td class="paramname"><em>forecast_state_at_lev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structInputSoundingData.html">InputSoundingData</a> &amp;&#160;</td>
          <td class="paramname"><em>input_sounding_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>is_slow_step</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Function for computing the slow RHS for the evolution equations for the density, potential temperature and momentum.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>current time </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>current slow or fast timestep size </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">S_data</td><td>current solution </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">xvel</td><td>x-component of velocity </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">yvel</td><td>y-component of velocity </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">xmom_src</td><td>source terms for x-momentum </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ymom_src</td><td>source terms for y-momentum </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">zmom_src</td><td>source terms for z-momentum </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">geom</td><td>Container for geometric information </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">solverChoice</td><td>Container for solver parameters </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">mapfac</td><td>map factors </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dptr_u_geos</td><td>custom geostrophic wind profile </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dptr_v_geos</td><td>custom geostrophic wind profile </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dptr_wbar_sub</td><td>subsidence source term </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">d_rayleigh_ptrs_at_lev</td><td>Vector of {strength of Rayleigh damping, reference value for xvel/yvel/zvel/theta} used to define Rayleigh damping </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">d_sinesq_at_lev</td><td>sin( (pi/2) (z-z_t)/(damping depth)) at cell centers </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">d_sinesq_stag_at_lev</td><td>sin( (pi/2) (z-z_t)/(damping depth)) at z-faces </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;{</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    BL_PROFILE_REGION(<span class="stringliteral">&quot;erf_make_mom_sources()&quot;</span>);</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160; </div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    Box domain(geom.Domain());</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <span class="keyword">const</span> GpuArray&lt;Real, AMREX_SPACEDIM&gt; dxInv = geom.InvCellSizeArray();</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160; </div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="comment">// Initialize sources to zero each time we may use them</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    xmom_src.setVal(0.0);</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    ymom_src.setVal(0.0);</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    zmom_src.setVal(0.0);</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160; </div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    MultiFab r_hse (base_state, make_alias, <a class="code" href="namespaceBaseState.html#a6f8dc3597225ea7941dad615e7f22e91abc888a343d4fcc4fc4ffb79c6ac7cb93">BaseState::r0_comp</a> , 1);</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160; </div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="comment">// flags to apply certain source terms in substep call only</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="keywordtype">bool</span> use_Rayleigh_fast_uv = ( (solverChoice.<a class="code" href="structSolverChoice.html#a2b3ba19d702463b82a9277b1d1e15dd5">dampingChoice</a>.<a class="code" href="structDampingChoice.html#a5e628d1d8bc5aa5423fc245af38bf38e">rayleigh_damping_type</a> == <a class="code" href="ERF__DampingStruct_8H.html#ada1fed43d749500e09ded1d6800449a1a09f7d3b242b6ede7372125e32efaaef1">RayleighDampingType::FastExplicit</a>) ||</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;                                  (solverChoice.<a class="code" href="structSolverChoice.html#a2b3ba19d702463b82a9277b1d1e15dd5">dampingChoice</a>.<a class="code" href="structDampingChoice.html#a5e628d1d8bc5aa5423fc245af38bf38e">rayleigh_damping_type</a> == <a class="code" href="ERF__DampingStruct_8H.html#ada1fed43d749500e09ded1d6800449a1af4e9679a52e3d536f79543ab20f3d8c6">RayleighDampingType::FastImplicit</a>) );</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="keywordtype">bool</span> use_Rayleigh_fast_w  = (solverChoice.<a class="code" href="structSolverChoice.html#a2b3ba19d702463b82a9277b1d1e15dd5">dampingChoice</a>.<a class="code" href="structDampingChoice.html#a5e628d1d8bc5aa5423fc245af38bf38e">rayleigh_damping_type</a> == <a class="code" href="ERF__DampingStruct_8H.html#ada1fed43d749500e09ded1d6800449a1a09f7d3b242b6ede7372125e32efaaef1">RayleighDampingType::FastExplicit</a>);</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <span class="keywordtype">bool</span> use_canopy_fast = solverChoice.<a class="code" href="structSolverChoice.html#af4e32876ca1a7d566f5cbe7f083f5a58">forest_substep</a>;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <span class="keywordtype">bool</span> use_ImmersedForcing_fast = solverChoice.<a class="code" href="structSolverChoice.html#a6399ecd90040753b8fb3469172910133">immersed_forcing_substep</a>;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160; </div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <span class="comment">// Define source term for all three components of momenta from</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="comment">//    1. Coriolis forcing for (xmom,ymom,zmom)</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <span class="comment">//    2. Rayleigh damping for (xmom,ymom,zmom)</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="comment">//    3. Constant / height-dependent geostrophic forcing</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="comment">//    4. Subsidence</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <span class="comment">//    5. Nudging towards input sounding data</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <span class="comment">//    6. Numerical diffusion for (xmom,ymom,zmom)</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <span class="comment">//    7. Sponge</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <span class="comment">//    8. Forest canopy</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="comment">//    9. Immersed forcing</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="comment">//   10. Constant mass flux</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <span class="comment">//   11. Vertical-velocity damping</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    <span class="comment">// NOTE: buoyancy is now computed in a separate routine - it should not appear here</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="comment">//const bool l_use_ndiff       = solverChoice.use_num_diff;</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160; </div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <span class="keywordflow">if</span> (solverChoice.<a class="code" href="structSolverChoice.html#ab734eb0a5147b93dc6590038b6decc60">terrain_type</a> == TerrainType::ImmersedForcing) {</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        <span class="keywordflow">if</span> (solverChoice.<a class="code" href="structSolverChoice.html#aed9118172b234c3a0069a78776d09baa">do_forest_drag</a>) {</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            amrex::Error(<span class="stringliteral">&quot; Currently forest canopy cannot be used with immersed forcing&quot;</span>);</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        }</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    }</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160; </div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160; </div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <span class="comment">// Data for Coriolis forcing</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="keyword">auto</span> use_coriolis         = solverChoice.<a class="code" href="structSolverChoice.html#a9e86533aa6df5bf6408d91f0dfd23606">use_coriolis</a>;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <span class="keyword">auto</span> coriolis_factor      = solverChoice.<a class="code" href="structSolverChoice.html#a1163778ed56af6977001ef4ec55a3da3">coriolis_factor</a>;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <span class="keyword">auto</span> cosphi               = solverChoice.<a class="code" href="structSolverChoice.html#a411fbfea721cd40033e113cf54a8047f">cosphi</a>;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="keyword">auto</span> sinphi               = solverChoice.<a class="code" href="structSolverChoice.html#a6426e150ba9c1ba2e14151228bf6ffaf">sinphi</a>;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="keyword">auto</span> var_coriolis         = solverChoice.<a class="code" href="structSolverChoice.html#aa54aafe316efc6cf474326d690fb2fbf">variable_coriolis</a>;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="keyword">auto</span> has_lat_lon          = solverChoice.<a class="code" href="structSolverChoice.html#ae2c963893d0c53465ac84c0bd8998a38">has_lat_lon</a>;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160; </div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="comment">// Flag for Geostrophic forcing</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="keyword">auto</span> abl_geo_forcing  = solverChoice.<a class="code" href="structSolverChoice.html#a5147634b7c1414a7694c59c1b4a88d69">abl_geo_forcing</a>;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keyword">auto</span> geo_wind_profile = solverChoice.<a class="code" href="structSolverChoice.html#a65faffc1ea490b3934a9df768cfa26f1">have_geo_wind_profile</a>;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160; </div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <span class="comment">// Data for Rayleigh damping</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="keyword">auto</span> rayleigh_damp_U  = solverChoice.<a class="code" href="structSolverChoice.html#a2b3ba19d702463b82a9277b1d1e15dd5">dampingChoice</a>.<a class="code" href="structDampingChoice.html#a816fcd32a74263a78093b4f590c845ee">rayleigh_damp_U</a>;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    <span class="keyword">auto</span> rayleigh_damp_V  = solverChoice.<a class="code" href="structSolverChoice.html#a2b3ba19d702463b82a9277b1d1e15dd5">dampingChoice</a>.<a class="code" href="structDampingChoice.html#a02972b3bec5a3b8aa713b50f2324d895">rayleigh_damp_V</a>;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <span class="keyword">auto</span> rayleigh_damp_W  = solverChoice.<a class="code" href="structSolverChoice.html#a2b3ba19d702463b82a9277b1d1e15dd5">dampingChoice</a>.<a class="code" href="structDampingChoice.html#a51caa6f9c76bc7a8ae5426fb3a73b00d">rayleigh_damp_W</a>;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160; </div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>*     <a class="code" href="ERF__DataStruct_8H.html#a3856c8a2f055327ada182186bfd70239a3d2cdf8cea6cb933d4ce759c1ff1b948">ubar</a> = d_rayleigh_ptrs_at_lev[<a class="code" href="ERF__DataStruct_8H.html#a3856c8a2f055327ada182186bfd70239a3d2cdf8cea6cb933d4ce759c1ff1b948">Rayleigh::ubar</a>];</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>*     <a class="code" href="ERF__DataStruct_8H.html#a3856c8a2f055327ada182186bfd70239acb08c6a1b8bca5e9e4ef6162aef2cfa4">vbar</a> = d_rayleigh_ptrs_at_lev[<a class="code" href="ERF__DataStruct_8H.html#a3856c8a2f055327ada182186bfd70239acb08c6a1b8bca5e9e4ef6162aef2cfa4">Rayleigh::vbar</a>];</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>*     <a class="code" href="ERF__DataStruct_8H.html#a3856c8a2f055327ada182186bfd70239a3d8bd6001a2421b06c3ec4e9f2dcdffd">wbar</a> = d_rayleigh_ptrs_at_lev[<a class="code" href="ERF__DataStruct_8H.html#a3856c8a2f055327ada182186bfd70239a3d8bd6001a2421b06c3ec4e9f2dcdffd">Rayleigh::wbar</a>];</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160; </div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <span class="comment">// Data for constant mass flux</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    <span class="keywordtype">bool</span> enforce_massflux_x = (solverChoice.<a class="code" href="structSolverChoice.html#a68e4ef883dc13cca7db5a58589f76f25">const_massflux_u</a> != 0);</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="keywordtype">bool</span> enforce_massflux_y = (solverChoice.<a class="code" href="structSolverChoice.html#a39ced5a090f246f82bdec3f5d288fcbc">const_massflux_v</a> != 0);</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> U_target = solverChoice.<a class="code" href="structSolverChoice.html#a68e4ef883dc13cca7db5a58589f76f25">const_massflux_u</a>;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> V_target = solverChoice.<a class="code" href="structSolverChoice.html#a39ced5a090f246f82bdec3f5d288fcbc">const_massflux_v</a>;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keywordtype">int</span> massflux_klo = solverChoice.<a class="code" href="structSolverChoice.html#a56b3643c43d3b6f0fa0f24adeee57f33">massflux_klo</a>;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="keywordtype">int</span> massflux_khi = solverChoice.<a class="code" href="structSolverChoice.html#af2ce02ea291687a31fdd716e2732acfa">massflux_khi</a>;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160; </div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="comment">// These will be updated by integrating through the planar average profiles</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rhoUA_target{0};</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rhoVA_target{0};</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rhoUA{0};</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rhoVA{0};</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160; </div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <span class="comment">// Planar averages for subsidence, nudging, or constant mass flux</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    Table1D&lt;Real&gt;     dptr_r_plane, dptr_u_plane, dptr_v_plane;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    TableData&lt;Real, 1&gt; r_plane_tab,  u_plane_tab,  v_plane_tab;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160; </div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    <span class="keywordflow">if</span> (is_slow_step &amp;&amp; (dptr_wbar_sub || solverChoice.<a class="code" href="structSolverChoice.html#a5a9eef80b6339778c29acb7fb87dd9f1">nudging_from_input_sounding</a> ||</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                         enforce_massflux_x || enforce_massflux_y))</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    {</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="ERF__ReadBndryPlanes_8cpp.html#a63d3125f6fd361f61d697799f46da817">offset</a> = 1;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">int</span> u_offset = 1;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">int</span> v_offset = 1;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160; </div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        <span class="comment">// We use the alias here to control ncomp inside the PlaneAverage</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        MultiFab <a class="code" href="namespaceVars.html#a3e5e550795a0b745a4e43177e81f8c57a47abe072e12c61d29cde15a509a0664b">cons</a>(S_data[<a class="code" href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269a2e7100afbf5e7a39371f1cb29f6f570a">IntVars::cons</a>], make_alias, 0, 1);</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160; </div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        IntVect ng_c = S_data[<a class="code" href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269a2e7100afbf5e7a39371f1cb29f6f570a">IntVars::cons</a>].nGrowVect(); ng_c[2] = <a class="code" href="ERF__ReadBndryPlanes_8cpp.html#a63d3125f6fd361f61d697799f46da817">offset</a>;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        <a class="code" href="classPlaneAverage.html">PlaneAverage</a> r_ave(&amp;<a class="code" href="namespaceVars.html#a3e5e550795a0b745a4e43177e81f8c57a47abe072e12c61d29cde15a509a0664b">cons</a>, geom, solverChoice.<a class="code" href="structSolverChoice.html#afdd906d035384fd962efab24e7a6da7c">ave_plane</a>, ng_c);</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        r_ave.compute_averages(<a class="code" href="ERF__DirectionSelector_8H.html#aca321ed7fddfe43ff7549b4632a3c0d1">ZDir</a>(), r_ave.field());</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160; </div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <span class="keywordtype">int</span> ncell = r_ave.ncell_line();</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        Gpu::HostVector&lt;    Real&gt; r_plane_h(ncell);</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        Gpu::DeviceVector&lt;  Real&gt; r_plane_d(ncell);</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160; </div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        r_ave.line_average(<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>, r_plane_h);</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160; </div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        Gpu::copyAsync(Gpu::hostToDevice, r_plane_h.begin(), r_plane_h.end(), r_plane_d.begin());</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160; </div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>* dptr_r = r_plane_d.data();</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160; </div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        Box tdomain  = domain; tdomain.grow(2,ng_c[2]);</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        r_plane_tab.resize({tdomain.smallEnd(2)}, {tdomain.bigEnd(2)});</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160; </div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        dptr_r_plane = r_plane_tab.table();</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        ParallelFor(ncell, [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> k) noexcept</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        {</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;            dptr_r_plane(k-<a class="code" href="ERF__ReadBndryPlanes_8cpp.html#a63d3125f6fd361f61d697799f46da817">offset</a>) = dptr_r[k];</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        });</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160; </div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        <span class="comment">// U and V momentum</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        IntVect ng_u = S_data[<a class="code" href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269af661293a5a71ca532c214929b98c0bad">IntVars::xmom</a>].nGrowVect(); ng_u[2] = u_offset;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        <a class="code" href="classPlaneAverage.html">PlaneAverage</a> u_ave(&amp;(S_data[<a class="code" href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269af661293a5a71ca532c214929b98c0bad">IntVars::xmom</a>]), geom, solverChoice.<a class="code" href="structSolverChoice.html#afdd906d035384fd962efab24e7a6da7c">ave_plane</a>, ng_u);</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160; </div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        IntVect ng_v = S_data[<a class="code" href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269a2e60798bc45154a8f905b1aa228a24e5">IntVars::ymom</a>].nGrowVect(); ng_v[2] = v_offset;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        <a class="code" href="classPlaneAverage.html">PlaneAverage</a> v_ave(&amp;(S_data[<a class="code" href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269a2e60798bc45154a8f905b1aa228a24e5">IntVars::ymom</a>]), geom, solverChoice.<a class="code" href="structSolverChoice.html#afdd906d035384fd962efab24e7a6da7c">ave_plane</a>, ng_v);</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160; </div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        u_ave.compute_averages(<a class="code" href="ERF__DirectionSelector_8H.html#aca321ed7fddfe43ff7549b4632a3c0d1">ZDir</a>(), u_ave.field());</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        v_ave.compute_averages(<a class="code" href="ERF__DirectionSelector_8H.html#aca321ed7fddfe43ff7549b4632a3c0d1">ZDir</a>(), v_ave.field());</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160; </div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="keywordtype">int</span> u_ncell = u_ave.ncell_line();</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        <span class="keywordtype">int</span> v_ncell = v_ave.ncell_line();</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        Gpu::HostVector&lt;    Real&gt; u_plane_h(u_ncell), v_plane_h(v_ncell);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        Gpu::DeviceVector&lt;  Real&gt; u_plane_d(u_ncell), v_plane_d(v_ncell);</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160; </div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        u_ave.line_average(0, u_plane_h);</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        v_ave.line_average(0, v_plane_h);</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160; </div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        Gpu::copyAsync(Gpu::hostToDevice, u_plane_h.begin(), u_plane_h.end(), u_plane_d.begin());</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        Gpu::copyAsync(Gpu::hostToDevice, v_plane_h.begin(), v_plane_h.end(), v_plane_d.begin());</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160; </div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>* dptr_u = u_plane_d.data();</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>* dptr_v = v_plane_d.data();</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160; </div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        Box udomain = domain; udomain.grow(2,ng_u[2]);</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        Box vdomain = domain; vdomain.grow(2,ng_v[2]);</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        u_plane_tab.resize({udomain.smallEnd(2)}, {udomain.bigEnd(2)});</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        v_plane_tab.resize({vdomain.smallEnd(2)}, {vdomain.bigEnd(2)});</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160; </div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        dptr_u_plane = u_plane_tab.table();</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        ParallelFor(u_ncell, [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> k) noexcept</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        {</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;            dptr_u_plane(k-u_offset) = dptr_u[k];</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        });</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160; </div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        dptr_v_plane = v_plane_tab.table();</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        ParallelFor(v_ncell, [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> k) noexcept</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        {</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;            dptr_v_plane(k-v_offset) = dptr_v[k];</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        });</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160; </div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        <span class="comment">// sum in z for massflux adjustment</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        <span class="keywordflow">if</span> (enforce_massflux_x || enforce_massflux_y) {</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;            <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> Lx = geom.ProbHi(0) - geom.ProbLo(0);</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;            <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> Ly = geom.ProbHi(1) - geom.ProbLo(1);</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160; </div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;            <span class="keywordflow">if</span> (solverChoice.<a class="code" href="structSolverChoice.html#a1952672901901b0b3a628f2298dc72c2">mesh_type</a> == MeshType::ConstantDz) {</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                <span class="comment">// note: massflux_khi corresponds to unstaggered indices in this case</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                rhoUA        = std::accumulate(u_plane_h.begin() + u_offset + massflux_klo,</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                                               u_plane_h.begin() + u_offset + massflux_khi+1, 0.0);</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                rhoVA        = std::accumulate(v_plane_h.begin() + v_offset + massflux_klo,</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                                               v_plane_h.begin() + v_offset + massflux_khi+1, 0.0);</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                rhoUA_target = std::accumulate(r_plane_h.begin() +   <a class="code" href="ERF__ReadBndryPlanes_8cpp.html#a63d3125f6fd361f61d697799f46da817">offset</a> + massflux_klo,</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                                               r_plane_h.begin() +   <a class="code" href="ERF__ReadBndryPlanes_8cpp.html#a63d3125f6fd361f61d697799f46da817">offset</a> + massflux_khi+1, 0.0);</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                rhoVA_target = rhoUA_target;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160; </div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                rhoUA        *= geom.CellSize(2) * Ly;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                rhoVA        *= geom.CellSize(2) * Lx;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                rhoUA_target *= geom.CellSize(2) * Ly;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                rhoVA_target *= geom.CellSize(2) * Lx;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160; </div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (solverChoice.<a class="code" href="structSolverChoice.html#a1952672901901b0b3a628f2298dc72c2">mesh_type</a> == MeshType::StretchedDz) {</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                <span class="comment">// note: massflux_khi corresponds to staggered indices in this case</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=massflux_klo; k &lt; massflux_khi; ++k) {</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                    rhoUA        += u_plane_h[k + u_offset] * stretched_dz_h[k];</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                    rhoVA        += v_plane_h[k + v_offset] * stretched_dz_h[k];</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                    rhoUA_target += r_plane_h[k +   <a class="code" href="ERF__ReadBndryPlanes_8cpp.html#a63d3125f6fd361f61d697799f46da817">offset</a>] * stretched_dz_h[k];</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                }</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                rhoVA_target = rhoUA_target;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160; </div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                rhoUA        *= Ly;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                rhoVA        *= Lx;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                rhoUA_target *= Ly;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                rhoVA_target *= Lx;</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;            }</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160; </div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;            <span class="comment">// at this point, this is integrated rho*dA</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;            rhoUA_target *= U_target;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;            rhoVA_target *= V_target;</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160; </div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;            Print() &lt;&lt; <span class="stringliteral">&quot;Integrated mass flux : &quot;</span> &lt;&lt; rhoUA &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; rhoVA</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                &lt;&lt; <span class="stringliteral">&quot; (target: &quot;</span> &lt;&lt; rhoUA_target &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; rhoVA_target &lt;&lt; <span class="stringliteral">&quot;)&quot;</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                &lt;&lt; std::endl;</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        }</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    }</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160; </div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="comment">// Add all the other forcings</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="keywordflow">for</span> ( MFIter mfi(S_data[<a class="code" href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269a2e7100afbf5e7a39371f1cb29f6f570a">IntVars::cons</a>]); mfi.isValid(); ++mfi)</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    {</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        Box tbx = mfi.nodaltilebox(0);</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        Box tby = mfi.nodaltilebox(1);</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        Box tbz = mfi.nodaltilebox(2);</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        <span class="keywordflow">if</span> (tbz.bigEnd(2) == domain.bigEnd(2)+1) tbz.growHi(2,-1);</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160; </div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; cell_data = S_data[<a class="code" href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269a2e7100afbf5e7a39371f1cb29f6f570a">IntVars::cons</a>].array(mfi);</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        <span class="keyword">const</span> Array4&lt;const Real&gt;&amp;     rho_u = S_data[<a class="code" href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269af661293a5a71ca532c214929b98c0bad">IntVars::xmom</a>].array(mfi);</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        <span class="keyword">const</span> Array4&lt;const Real&gt;&amp;     rho_v = S_data[<a class="code" href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269a2e60798bc45154a8f905b1aa228a24e5">IntVars::ymom</a>].array(mfi);</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        <span class="keyword">const</span> Array4&lt;const Real&gt;&amp;     rho_w = S_data[<a class="code" href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269aaab25f707cae69bfadac2abcd17a2188">IntVars::zmom</a>].array(mfi);</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160; </div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; u = <a class="code" href="namespaceVars.html#a3e5e550795a0b745a4e43177e81f8c57a2a10a6e726515894b07621908abd4c0c">xvel</a>.array(mfi);</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; v = <a class="code" href="namespaceVars.html#a3e5e550795a0b745a4e43177e81f8c57a81793b83204cfa56d4683bc676fbbfb6">yvel</a>.array(mfi);</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; w = wvel.array(mfi);</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160; </div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        <span class="keyword">const</span> Array4&lt;      Real&gt;&amp; xmom_src_arr = xmom_src.array(mfi);</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        <span class="keyword">const</span> Array4&lt;      Real&gt;&amp; ymom_src_arr = ymom_src.array(mfi);</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        <span class="keyword">const</span> Array4&lt;      Real&gt;&amp; zmom_src_arr = zmom_src.array(mfi);</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160; </div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; r0 = r_hse.const_array(mfi);</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160; </div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; f_drag_arr = (forest_drag) ? forest_drag-&gt;const_array(mfi) :</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                                                               Array4&lt;const Real&gt;{};</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; t_blank_arr = (terrain_blank) ? terrain_blank-&gt;const_array(mfi) :</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                                                               Array4&lt;const Real&gt;{};</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160; </div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; cphi_arr = (cosPhi_mf) ? cosPhi_mf-&gt;const_array(mfi) :</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                                                           Array4&lt;const Real&gt;{};</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; sphi_arr = (sinPhi_mf) ? sinPhi_mf-&gt;const_array(mfi) :</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                                                           Array4&lt;const Real&gt;{};</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160; </div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; z_nd_arr =  z_phys_nd.const_array(mfi);</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; z_cc_arr =  z_phys_cc.const_array(mfi);</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160; </div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160; </div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        <span class="comment">// 1. Add CORIOLIS forcing (this assumes east is +x, north is +y)</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        <span class="keywordflow">if</span> (use_coriolis &amp;&amp; is_slow_step) {</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;            <span class="keywordflow">if</span>(solverChoice.<a class="code" href="structSolverChoice.html#ac1ddc9c301ac98689bf3b7b7184b24e1">init_type</a> == InitType::HindCast) {</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; latlon_arr = (*forecast_state_at_lev)[4].array(mfi);</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                ParallelFor(tbx, tby, tbz,</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k)</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                {</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_v_loc = 0.25 * (rho_v(i,j+1,k) + rho_v(i,j,k) + rho_v(i-1,j+1,k) + rho_v(i-1,j,k));</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_w_loc = 0.25 * (rho_w(i,j,k+1) + rho_w(i,j,k) + rho_w(i,j-1,k+1) + rho_w(i,j-1,k));</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> latitude = latlon_arr(i,j,k,0);</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> sphi_loc = std::sin(latitude*<a class="code" href="ERF__Constants_8H.html#a988c4efd6fd0d855e241e77a73191428">PI</a>/180.0);</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> cphi_loc = std::cos(latitude*<a class="code" href="ERF__Constants_8H.html#a988c4efd6fd0d855e241e77a73191428">PI</a>/180.0);</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                    xmom_src_arr(i, j, k) += coriolis_factor * (rho_v_loc * sphi_loc - rho_w_loc * cphi_loc);</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                },</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) {</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_u_loc = 0.25 * (rho_u(i+1,j,k) + rho_u(i,j,k) + rho_u(i+1,j-1,k) + rho_u(i,j-1,k));</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> latitude = latlon_arr(i,j,k,0);</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> sphi_loc = std::sin(latitude*<a class="code" href="ERF__Constants_8H.html#a988c4efd6fd0d855e241e77a73191428">PI</a>/180.0);</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                    ymom_src_arr(i, j, k) += -coriolis_factor * rho_u_loc * sphi_loc;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                },</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) {</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_u_loc = 0.25 * (rho_u(i+1,j,k) + rho_u(i,j,k) + rho_u(i+1,j,k-1) + rho_u(i,j,k-1));</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> latitude = latlon_arr(i,j,k,0);</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> cphi_loc = std::cos(latitude*<a class="code" href="ERF__Constants_8H.html#a988c4efd6fd0d855e241e77a73191428">PI</a>/180.0);</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                    zmom_src_arr(i, j, k) += coriolis_factor * rho_u_loc * cphi_loc;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                });</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;            }</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (var_coriolis &amp;&amp; has_lat_lon) {</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                ParallelFor(tbx, tby, tbz,</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k)</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                {</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_v_loc = 0.25 * (rho_v(i,j+1,k) + rho_v(i,j,k) + rho_v(i-1,j+1,k) + rho_v(i-1,j,k));</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_w_loc = 0.25 * (rho_w(i,j,k+1) + rho_w(i,j,k) + rho_w(i,j-1,k+1) + rho_w(i,j-1,k));</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> sphi_loc  = 0.5  * (sphi_arr(i,j,0) + sphi_arr(i-1,j,0));</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> cphi_loc  = 0.5  * (cphi_arr(i,j,0) + cphi_arr(i-1,j,0));</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                    xmom_src_arr(i, j, k) += coriolis_factor * (rho_v_loc * sphi_loc - rho_w_loc * cphi_loc);</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                },</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) {</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_u_loc = 0.25 * (rho_u(i+1,j,k) + rho_u(i,j,k) + rho_u(i+1,j-1,k) + rho_u(i,j-1,k));</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> sphi_loc  = 0.5  * (sphi_arr(i,j,0) + sphi_arr(i,j-1,0));</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                    ymom_src_arr(i, j, k) += -coriolis_factor * rho_u_loc * sphi_loc;</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                },</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) {</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_u_loc = 0.25 * (rho_u(i+1,j,k) + rho_u(i,j,k) + rho_u(i+1,j,k-1) + rho_u(i,j,k-1));</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                    zmom_src_arr(i, j, k) += coriolis_factor * rho_u_loc * cphi_arr(i,j,0);</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                });</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                ParallelFor(tbx, tby, tbz,</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;                [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k)</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                {</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_v_loc = 0.25 * (rho_v(i,j+1,k) + rho_v(i,j,k) + rho_v(i-1,j+1,k) + rho_v(i-1,j,k));</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_w_loc = 0.25 * (rho_w(i,j,k+1) + rho_w(i,j,k) + rho_w(i,j-1,k+1) + rho_w(i,j-1,k));</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                    xmom_src_arr(i, j, k) += coriolis_factor * (rho_v_loc * sinphi - rho_w_loc * cosphi);</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                },</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) {</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_u_loc = 0.25 * (rho_u(i+1,j,k) + rho_u(i,j,k) + rho_u(i+1,j-1,k) + rho_u(i,j-1,k));</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                    ymom_src_arr(i, j, k) += -coriolis_factor * rho_u_loc * sinphi;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                },</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) {</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_u_loc = 0.25 * (rho_u(i+1,j,k) + rho_u(i,j,k) + rho_u(i+1,j,k-1) + rho_u(i,j,k-1));</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                    zmom_src_arr(i, j, k) += coriolis_factor * rho_u_loc * cosphi;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                });</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;            } <span class="comment">// var_coriolis</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        } <span class="comment">// use_coriolis</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160; </div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        <span class="comment">// 2. Add RAYLEIGH damping</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> dampcoef = solverChoice.<a class="code" href="structSolverChoice.html#a2b3ba19d702463b82a9277b1d1e15dd5">dampingChoice</a>.<a class="code" href="structDampingChoice.html#a4b77c2ff2209611231f61a4f7be26cab">rayleigh_dampcoef</a>;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160; </div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        <span class="keywordflow">if</span> ( (is_slow_step &amp;&amp; !use_Rayleigh_fast_uv) || (!is_slow_step &amp;&amp; use_Rayleigh_fast_uv)) {</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;            <span class="keywordflow">if</span> (rayleigh_damp_U) {</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                ParallelFor(tbx, [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k)</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                {</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_on_u_face = 0.5 * ( cell_data(i,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) + cell_data(i-1,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) );</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uu = rho_u(i,j,k) / rho_on_u_face;</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> sinesq = d_sinesq_at_lev[k];</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                    xmom_src_arr(i, j, k) -= dampcoef*sinesq * (uu - <a class="code" href="ERF__DataStruct_8H.html#a3856c8a2f055327ada182186bfd70239a3d2cdf8cea6cb933d4ce759c1ff1b948">ubar</a>[k]) * rho_on_u_face;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                });</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;            }</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160; </div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            <span class="keywordflow">if</span> (rayleigh_damp_V) {</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;                ParallelFor(tby, [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k)</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;                {</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_on_v_face = 0.5 * ( cell_data(i,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) + cell_data(i,j-1,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) );</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> vv = rho_v(i,j,k) / rho_on_v_face;</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> sinesq = d_sinesq_at_lev[k];</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                    ymom_src_arr(i, j, k) -= dampcoef*sinesq * (vv - <a class="code" href="ERF__DataStruct_8H.html#a3856c8a2f055327ada182186bfd70239acb08c6a1b8bca5e9e4ef6162aef2cfa4">vbar</a>[k]) * rho_on_v_face;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                });</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;            }</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        } <span class="comment">// fast or slow step</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160; </div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        <span class="keywordflow">if</span> ( (is_slow_step &amp;&amp; !use_Rayleigh_fast_w) || (!is_slow_step &amp;&amp; use_Rayleigh_fast_w)) {</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;            <span class="keywordflow">if</span> (rayleigh_damp_W) {</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                    ParallelFor(tbz, [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k)</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;                {</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_on_w_face = 0.5 * ( cell_data(i,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) + cell_data(i,j,k-1,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) );</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> ww = rho_w(i,j,k) / rho_on_w_face;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> sinesq = d_sinesq_stag_at_lev[k];</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                    zmom_src_arr(i, j, k) -= dampcoef*sinesq * (ww - <a class="code" href="ERF__DataStruct_8H.html#a3856c8a2f055327ada182186bfd70239a3d8bd6001a2421b06c3ec4e9f2dcdffd">wbar</a>[k]) * rho_on_w_face;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                });</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;            }</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        } <span class="comment">// fast or slow step</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160; </div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        <span class="comment">// 3a. Add constant GEOSTROPHIC forcing</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        <span class="keywordflow">if</span> (is_slow_step) {</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;            ParallelFor(tbx, tby, tbz,</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;            [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k)</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;            {</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_on_u_face = 0.5 * ( cell_data(i,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) + cell_data(i-1,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) );</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                xmom_src_arr(i, j, k) += rho_on_u_face * abl_geo_forcing[0];</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;            },</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;            [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k)</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;            {</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;                <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_on_v_face = 0.5 * ( cell_data(i,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) + cell_data(i,j-1,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) );</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;                ymom_src_arr(i, j, k) += rho_on_v_face * abl_geo_forcing[1];</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;            },</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;            [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k)</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;            {</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_on_w_face = 0.5 * ( cell_data(i,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) + cell_data(i,j,k-1,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) );</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                zmom_src_arr(i, j, k) += rho_on_w_face * abl_geo_forcing[2];</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;            });</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        }</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160; </div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;        <span class="comment">// 3b. Add height-dependent GEOSTROPHIC forcing</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;        <span class="keywordflow">if</span> (geo_wind_profile &amp;&amp; is_slow_step) {</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            ParallelFor(tbx, tby,</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;            [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k)</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;            {</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_on_u_face = 0.5 * ( cell_data(i,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) + cell_data(i-1,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) );</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                xmom_src_arr(i, j, k) -= coriolis_factor * rho_on_u_face * dptr_v_geos[k] * sinphi;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;            },</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;            [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k)</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;            {</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_on_v_face = 0.5 * ( cell_data(i,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) + cell_data(i,j-1,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) );</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                ymom_src_arr(i, j, k) += coriolis_factor * rho_on_v_face * dptr_u_geos[k] * sinphi;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;            });</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;        } <span class="comment">// geo_wind_profile</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160; </div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;        <span class="comment">// 4. Add custom SUBSIDENCE terms</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;        <span class="keywordflow">if</span> (solverChoice.<a class="code" href="structSolverChoice.html#a596f061b796ada0389c81a6125150b6e">custom_w_subsidence</a> &amp;&amp; is_slow_step) {</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;            <span class="keywordflow">if</span> (solverChoice.<a class="code" href="structSolverChoice.html#aae4f377d36d01b85a1f322c45009ac75">custom_forcing_prim_vars</a>) {</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespaceMicVar__Morr.html#aee8eabea0690943ba287c93caab8c1b7a6764e4c83976308b665ab846e77b53b0">nr</a> = <a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>;</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                ParallelFor(tbx, tby,</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) noexcept</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                {</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> dzInv = 0.5*dxInv[2];</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                    <span class="keywordflow">if</span> (z_nd_arr) {</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                        <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> z_xf_lo = 0.25 * ( z_nd_arr(i,j,k  ) + z_nd_arr(i,j+1,k  )</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                                              + z_nd_arr(i,j,k-1) + z_nd_arr(i,j+1,k-1) );</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                        <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> z_xf_hi = 0.25 * ( z_nd_arr(i,j,k+1) + z_nd_arr(i,j+1,k+1)</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                                              + z_nd_arr(i,j,k+2) + z_nd_arr(i,j+1,k+2) );</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                        dzInv = 1.0 / (z_xf_hi - z_xf_lo);</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                    }</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_on_u_face = 0.5 * ( cell_data(i,j,k,<a class="code" href="namespaceMicVar__Morr.html#aee8eabea0690943ba287c93caab8c1b7a6764e4c83976308b665ab846e77b53b0">nr</a>) + cell_data(i-1,j,k,<a class="code" href="namespaceMicVar__Morr.html#aee8eabea0690943ba287c93caab8c1b7a6764e4c83976308b665ab846e77b53b0">nr</a>) );</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> U_hi = dptr_u_plane(k+1) / dptr_r_plane(k+1);</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> U_lo = dptr_u_plane(k-1) / dptr_r_plane(k-1);</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> wbar_xf = 0.5 * (dptr_wbar_sub[k] + dptr_wbar_sub[k+1]);</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                    xmom_src_arr(i, j, k) -= rho_on_u_face * wbar_xf * (U_hi - U_lo) * dzInv;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                },</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) noexcept</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;                {</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> dzInv = 0.5*dxInv[2];</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                    <span class="keywordflow">if</span> (z_nd_arr) {</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                        <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> z_yf_lo = 0.25 * ( z_nd_arr(i,j,k  ) + z_nd_arr(i+1,j,k  )</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;                                              + z_nd_arr(i,j,k-1) + z_nd_arr(i+1,j,k-1) );</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                        <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> z_yf_hi = 0.25 * ( z_nd_arr(i,j,k+1) + z_nd_arr(i+1,j,k+1)</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                                              + z_nd_arr(i,j,k+2) + z_nd_arr(i+1,j,k+2) );</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;                        dzInv = 1.0 / (z_yf_hi - z_yf_lo);</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                    }</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_on_v_face = 0.5 * ( cell_data(i,j,k,<a class="code" href="namespaceMicVar__Morr.html#aee8eabea0690943ba287c93caab8c1b7a6764e4c83976308b665ab846e77b53b0">nr</a>) + cell_data(i,j-1,k,<a class="code" href="namespaceMicVar__Morr.html#aee8eabea0690943ba287c93caab8c1b7a6764e4c83976308b665ab846e77b53b0">nr</a>) );</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> V_hi = dptr_v_plane(k+1) / dptr_r_plane(k+1);</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> V_lo = dptr_v_plane(k-1) / dptr_r_plane(k-1);</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> wbar_yf = 0.5 * (dptr_wbar_sub[k] + dptr_wbar_sub[k+1]);</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                    ymom_src_arr(i, j, k) -= rho_on_v_face * wbar_yf * (V_hi - V_lo) * dzInv;</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                });</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                ParallelFor(tbx, tby,</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) noexcept</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                {</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> dzInv = 0.5*dxInv[2];</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;                    <span class="keywordflow">if</span> (z_nd_arr) {</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                        <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> z_xf_lo = 0.25 * ( z_nd_arr(i,j,k  ) + z_nd_arr(i,j+1,k  )</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                                              + z_nd_arr(i,j,k-1) + z_nd_arr(i,j+1,k-1) );</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                        <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> z_xf_hi = 0.25 * ( z_nd_arr(i,j,k+1) + z_nd_arr(i,j+1,k+1)</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                                              + z_nd_arr(i,j,k+2) + z_nd_arr(i,j+1,k+2) );</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                        dzInv = 1.0 / (z_xf_hi - z_xf_lo);</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                    }</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> U_hi = dptr_u_plane(k+1) / dptr_r_plane(k+1);</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> U_lo = dptr_u_plane(k-1) / dptr_r_plane(k-1);</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> wbar_xf = 0.5 * (dptr_wbar_sub[k] + dptr_wbar_sub[k+1]);</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                    xmom_src_arr(i, j, k) -= wbar_xf * (U_hi - U_lo) * dzInv;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                },</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) noexcept</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;                {</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> dzInv = 0.5*dxInv[2];</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                    <span class="keywordflow">if</span> (z_nd_arr) {</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                        <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> z_yf_lo = 0.25 * ( z_nd_arr(i,j,k  ) + z_nd_arr(i+1,j,k  )</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                                              + z_nd_arr(i,j,k-1) + z_nd_arr(i+1,j,k-1) );</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;                        <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> z_yf_hi = 0.25 * ( z_nd_arr(i,j,k+1) + z_nd_arr(i+1,j,k+1)</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;                                              + z_nd_arr(i,j,k+2) + z_nd_arr(i+1,j,k+2) );</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;                        dzInv = 1.0 / (z_yf_hi - z_yf_lo);</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;                    }</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> V_hi = dptr_v_plane(k+1) / dptr_r_plane(k+1);</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> V_lo = dptr_v_plane(k-1) / dptr_r_plane(k-1);</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> wbar_yf = 0.5 * (dptr_wbar_sub[k] + dptr_wbar_sub[k+1]);</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;                    ymom_src_arr(i, j, k) -= wbar_yf * (V_hi - V_lo) * dzInv;</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                });</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;            }</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        }</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160; </div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;        <span class="comment">// *************************************************************************************</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        <span class="comment">// 5. Add nudging towards value specified in input sounding</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;        <span class="comment">// *************************************************************************************</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        <span class="keywordflow">if</span> (solverChoice.<a class="code" href="structSolverChoice.html#a5a9eef80b6339778c29acb7fb87dd9f1">nudging_from_input_sounding</a> &amp;&amp; is_slow_step)</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        {</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;            <span class="keywordtype">int</span> itime_n    = 0;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;            <span class="keywordtype">int</span> itime_np1  = 0;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;            <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> coeff_n   = <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>(1.0);</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;            <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> coeff_np1 = <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>(0.0);</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160; </div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;            <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> tau_inv = <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>(1.0) / input_sounding_data.<a class="code" href="structInputSoundingData.html#a5c190ab2ffec63277427ed6c92d4f53f">tau_nudging</a>;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160; </div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;            <span class="keywordtype">int</span> n_sounding_times = input_sounding_data.<a class="code" href="structInputSoundingData.html#a4f3f4e6859d978e727af01ca625aea1b">input_sounding_time</a>.size();</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160; </div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> nt = 1; nt &lt; n_sounding_times; nt++) {</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                <span class="keywordflow">if</span> (time &gt; input_sounding_data.<a class="code" href="structInputSoundingData.html#a4f3f4e6859d978e727af01ca625aea1b">input_sounding_time</a>[nt]) itime_n = nt;</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;            }</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;            <span class="keywordflow">if</span> (itime_n == n_sounding_times-1) {</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;                itime_np1 = itime_n;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                itime_np1 = itime_n+1;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                coeff_np1 = (time                                               - input_sounding_data.<a class="code" href="structInputSoundingData.html#a4f3f4e6859d978e727af01ca625aea1b">input_sounding_time</a>[itime_n]) /</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                            (input_sounding_data.<a class="code" href="structInputSoundingData.html#a4f3f4e6859d978e727af01ca625aea1b">input_sounding_time</a>[itime_np1] - input_sounding_data.<a class="code" href="structInputSoundingData.html#a4f3f4e6859d978e727af01ca625aea1b">input_sounding_time</a>[itime_n]);</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;                coeff_n   = <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>(1.0) - coeff_np1;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;            }</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160; </div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;            <span class="keywordtype">int</span> <a class="code" href="namespaceMicVar__Morr.html#aee8eabea0690943ba287c93caab8c1b7a6764e4c83976308b665ab846e77b53b0">nr</a> = <a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160; </div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>* u_inp_sound_n   = input_sounding_data.<a class="code" href="structInputSoundingData.html#ab040f8bf9b86d53f6acda8c10844c20f">U_inp_sound_d</a>[itime_n].dataPtr();</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>* u_inp_sound_np1 = input_sounding_data.<a class="code" href="structInputSoundingData.html#ab040f8bf9b86d53f6acda8c10844c20f">U_inp_sound_d</a>[itime_np1].dataPtr();</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>* v_inp_sound_n   = input_sounding_data.<a class="code" href="structInputSoundingData.html#a36f5c3dc9c536d7a6da2f87d67ea6a08">V_inp_sound_d</a>[itime_n].dataPtr();</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>* v_inp_sound_np1 = input_sounding_data.<a class="code" href="structInputSoundingData.html#a36f5c3dc9c536d7a6da2f87d67ea6a08">V_inp_sound_d</a>[itime_np1].dataPtr();</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;            ParallelFor(tbx, tby,</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;            [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) noexcept</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;            {</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> nudge_u = (coeff_n*u_inp_sound_n[k] + coeff_np1*u_inp_sound_np1[k]) - (dptr_u_plane(k)/dptr_r_plane(k));</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                nudge_u *= tau_inv;</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                xmom_src_arr(i, j, k) += cell_data(i, j, k, <a class="code" href="namespaceMicVar__Morr.html#aee8eabea0690943ba287c93caab8c1b7a6764e4c83976308b665ab846e77b53b0">nr</a>) * nudge_u;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;            },</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;            [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) noexcept</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;            {</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;                <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> nudge_v = (coeff_n*v_inp_sound_n[k] + coeff_np1*v_inp_sound_np1[k]) - (dptr_v_plane(k)/dptr_r_plane(k));</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;                nudge_v *= tau_inv;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;                ymom_src_arr(i, j, k) += cell_data(i, j, k, <a class="code" href="namespaceMicVar__Morr.html#aee8eabea0690943ba287c93caab8c1b7a6764e4c83976308b665ab846e77b53b0">nr</a>) * nudge_v;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;            });</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        }</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160; </div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;        <span class="comment">// 6. Add NUMERICAL DIFFUSION terms</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="preprocessor">#if 0</span></div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        <span class="keywordflow">if</span> (l_use_ndiff) {</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;            <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; mf_ux   = mapfac[MapFac::ux]-&gt;const_array(mfi);</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;            <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; mf_uy   = mapfac[MapFac::uy]-&gt;const_array(mfi);</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;            <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; mf_vx   = mapfac[MapFac::vx]-&gt;const_array(mfi);</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;            <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; mf_vy   = mapfac[MapFac::vy]-&gt;const_array(mfi);</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;            <a class="code" href="ERF__NumericalDiffusion_8cpp.html#ac9ebbec8e0b9fe65aca431e66186fb1d">NumericalDiffusion_Xmom</a>(tbx, dt, solverChoice.<a class="code" href="structSolverChoice.html#aa368e98496254e9aaf594ecf0e4e9981">num_diff_coeff</a>,</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                                    u, cell_data, xmom_src_arr, mf_ux, mf_uy);</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;            <a class="code" href="ERF__NumericalDiffusion_8cpp.html#a55bafde70bac8a562579a7ba5c0c53f3">NumericalDiffusion_Ymom</a>(tby, dt, solverChoice.<a class="code" href="structSolverChoice.html#aa368e98496254e9aaf594ecf0e4e9981">num_diff_coeff</a>,</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;                                    v, cell_data, ymom_src_arr, mf_vx, mf_vy);</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        }</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160; </div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        <span class="comment">// 7. Add SPONGING</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        <span class="keywordflow">if</span> (is_slow_step) {</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;            <span class="keywordflow">if</span> (solverChoice.<a class="code" href="structSolverChoice.html#ac066852f06a6409e1638f59868b7c57d">spongeChoice</a>.<a class="code" href="structSpongeChoice.html#a1a41f754595d713df32583f0b0fa606e">sponge_type</a> == <span class="stringliteral">&quot;input_sponge&quot;</span>)</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;            {</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                <a class="code" href="ERF__ApplySpongeZoneBCs__ReadFromFile_8cpp.html#a9bd7c438851be0734e672135ae63d11e">ApplySpongeZoneBCsForMom_ReadFromFile</a>(solverChoice.<a class="code" href="structSolverChoice.html#ac066852f06a6409e1638f59868b7c57d">spongeChoice</a>, geom, tbx, tby, cell_data,</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;                                                    z_cc_arr, xmom_src_arr, ymom_src_arr,</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;                                                    rho_u, rho_v, d_sponge_ptrs_at_lev);</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;            }</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;            {</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;                <a class="code" href="ERF__ApplySpongeZoneBCs_8cpp.html#a0ac83a02df7ee64733226f722e601784">ApplySpongeZoneBCsForMom</a>(solverChoice.<a class="code" href="structSolverChoice.html#ac066852f06a6409e1638f59868b7c57d">spongeChoice</a>, geom, tbx, tby, tbz,</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;                                        xmom_src_arr, ymom_src_arr, zmom_src_arr, rho_u, rho_v, rho_w,</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                                        r0, z_nd_arr, z_cc_arr);</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;            }</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160; </div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;            <span class="keywordflow">if</span>(solverChoice.<a class="code" href="structSolverChoice.html#ac1ddc9c301ac98689bf3b7b7184b24e1">init_type</a> == InitType::HindCast and solverChoice.<a class="code" href="structSolverChoice.html#a55a99c03ba69de86126f37568875944a">hindcast_lateral_forcing</a>){</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160; </div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; rho_u_forecast_state  = (*forecast_state_at_lev)[<a class="code" href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269af661293a5a71ca532c214929b98c0bad">IntVars::xmom</a>].array(mfi);</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; rho_v_forecast_state  = (*forecast_state_at_lev)[<a class="code" href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269a2e60798bc45154a8f905b1aa228a24e5">IntVars::ymom</a>].array(mfi);</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; rho_w_forecast_state  = (*forecast_state_at_lev)[<a class="code" href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269aaab25f707cae69bfadac2abcd17a2188">IntVars::zmom</a>].array(mfi);</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;                <span class="keyword">const</span> Array4&lt;const Real&gt;&amp; cons_forecast_state   = (*forecast_state_at_lev)[<a class="code" href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269a2e7100afbf5e7a39371f1cb29f6f570a">IntVars::cons</a>].array(mfi);</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                <a class="code" href="ERF__ApplyBndryForcing__Forecast_8cpp.html#a44a9506e5ba1a6a6ab085b5d5a0fdd44">ApplyBndryForcing_Forecast</a>(solverChoice, geom, tbx, tby, tbz, z_nd_arr,</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                                           xmom_src_arr, ymom_src_arr, zmom_src_arr,</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                                           rho_u, rho_v, rho_w,</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                                           rho_u_forecast_state, rho_v_forecast_state, rho_w_forecast_state,</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                                           cons_forecast_state);</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;            }</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        }</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160; </div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        <span class="comment">// 8. Add CANOPY source terms</span></div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        <span class="keywordflow">if</span> (solverChoice.<a class="code" href="structSolverChoice.html#aed9118172b234c3a0069a78776d09baa">do_forest_drag</a> &amp;&amp;</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;           ((is_slow_step &amp;&amp; !use_canopy_fast) || (!is_slow_step &amp;&amp; use_canopy_fast))) {</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;            ParallelFor(tbx, tby, tbz,</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;            [=] AMREX_GPU_DEVICE(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) noexcept</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;            {</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> ux = u(i, j, k);</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uy = 0.25 * ( v(i, j  , k  ) + v(i-1, j  , k  )</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                                       + v(i, j+1, k  ) + v(i-1, j+1, k  ) );</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uz = 0.25 * ( w(i, j  , k  ) + w(i-1, j  , k  )</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;                                       + w(i, j  , k+1) + w(i-1, j  , k+1) );</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> windspeed = std::sqrt(ux * ux + uy * uy + uz * uz);</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> f_drag = 0.5 * (f_drag_arr(i, j, k) + f_drag_arr(i-1, j, k));</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;                xmom_src_arr(i, j, k) -= f_drag * ux * windspeed;</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;            },</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;            [=] AMREX_GPU_DEVICE(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) noexcept</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;            {</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> ux = 0.25 * ( u(i  , j  , k  ) + u(i  , j-1, k  )</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                                       + u(i+1, j  , k  ) + u(i+1, j-1, k  ) );</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uy = v(i, j, k);</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uz = 0.25 * ( w(i  , j  , k  ) + w(i  , j-1, k  )</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                                       + w(i  , j  , k+1) + w(i  , j-1, k+1) );</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">amrex::Real</a> windspeed = std::sqrt(ux * ux + uy * uy + uz * uz);</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> f_drag = 0.5 * (f_drag_arr(i, j, k) + f_drag_arr(i, j-1, k));</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;                ymom_src_arr(i, j, k) -= f_drag * uy * windspeed;</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;            },</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;            [=] AMREX_GPU_DEVICE(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) noexcept</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;            {</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">amrex::Real</a> ux = 0.25 * ( u(i  , j  , k  ) + u(i+1, j  , k  )</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;                                              + u(i  , j  , k-1) + u(i+1, j  , k-1) );</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">amrex::Real</a> uy = 0.25 * ( v(i  , j  , k  ) + v(i  , j+1, k  )</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;                                              + v(i  , j  , k-1) + v(i  , j+1, k-1) );</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">amrex::Real</a> uz = w(i, j, k);</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">amrex::Real</a> windspeed = std::sqrt(ux * ux + uy * uy + uz * uz);</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> f_drag = 0.5 * (f_drag_arr(i, j, k) + f_drag_arr(i, j, k-1));</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                zmom_src_arr(i, j, k) -= f_drag * uz * windspeed;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;            });</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;        }</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        <span class="comment">// 9. Add Immersed source terms</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;        <span class="keywordflow">if</span> (solverChoice.<a class="code" href="structSolverChoice.html#ab734eb0a5147b93dc6590038b6decc60">terrain_type</a> == TerrainType::ImmersedForcing &amp;&amp;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;           ((is_slow_step &amp;&amp; !use_ImmersedForcing_fast) || (!is_slow_step &amp;&amp; use_ImmersedForcing_fast))) {</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160; </div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;            <span class="comment">// geometric properties</span></div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>* dx_arr = geom.CellSize();</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> dx_x = dx_arr[0];</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> dx_y = dx_arr[1];</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> dx_z = dx_arr[2];</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160; </div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> alpha_m = solverChoice.<a class="code" href="structSolverChoice.html#aa7c402e8c29a8f8bbc42ad2701f4132a">if_Cd_momentum</a>;</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> drag_coefficient = alpha_m / std::pow(dx_x*dx_y*dx_z, 1./3.);</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> tiny = <a class="code" href="namespacemodule__model__constants.html#a8aff14ee510fe368c6991bc969cb5721">std::numeric_limits&lt;amrex::Real&gt;::epsilon</a>();</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> U_s = 1.0; <span class="comment">// unit velocity scale</span></div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160; </div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;            <span class="comment">// MOST parameters</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;            <a class="code" href="structsimilarity__funs.html">similarity_funs</a> sfuns;</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> ggg        = <a class="code" href="ERF__Constants_8H.html#ac2d0c304ab1117368778efcda612de43">CONST_GRAV</a>;</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> kappa      = <a class="code" href="ERF__Constants_8H.html#a0f51e1ef58cb9a3add46666cc98e6093">KAPPA</a>;</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> z0                 = solverChoice.<a class="code" href="structSolverChoice.html#a3a2b3ea3da7ce2b79df1b4b8f903f035">if_z0</a>;</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> tflux_in           = solverChoice.<a class="code" href="structSolverChoice.html#a1a296d36b81b342c5da390a72421c6c6">if_surf_temp_flux</a>;</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;            <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> Olen_in            = solverChoice.<a class="code" href="structSolverChoice.html#a819a44bb3c482bb99471bc07b2da8ff3">if_Olen_in</a>;</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">bool</span> l_use_most         = solverChoice.<a class="code" href="structSolverChoice.html#a2b1552473c77cafa7760c84fcff79650">if_use_most</a>;</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160; </div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;            ParallelFor(tbx, [=] AMREX_GPU_DEVICE(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) noexcept</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;            {</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> ux = u(i, j, k);</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uy = 0.25 * ( v(i, j  , k  ) + v(i-1, j  , k  )</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;                                       + v(i, j+1, k  ) + v(i-1, j+1, k  ) );</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uz = 0.25 * ( w(i, j  , k  ) + w(i-1, j  , k  )</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;                                       + w(i, j  , k+1) + w(i-1, j  , k+1) );</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> windspeed = std::sqrt(ux * ux + uy * uy + uz * uz);</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> t_blank = 0.5 * (t_blank_arr(i, j, k) + t_blank_arr(i-1, j, k));</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> t_blank_above = 0.5 * (t_blank_arr(i, j, k+1) + t_blank_arr(i-1, j, k+1));</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> CdM = std::min(drag_coefficient / (windspeed + tiny), 1000.0);</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_xface = 0.5 * ( cell_data(i,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) + cell_data(i-1,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) );</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160; </div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;                <span class="keywordflow">if</span> ((t_blank &gt; 0 &amp;&amp; (t_blank_above == 0.0)) &amp;&amp; l_use_most) { <span class="comment">// force to MOST value</span></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                    <span class="comment">// calculate tangential velocity one cell above</span></div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> ux2r = u(i, j, k+1) ;</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uy2r = 0.25 * ( v(i, j  , k+1) + v(i-1, j  , k+1)</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;                                       + v(i, j+1, k+1) + v(i-1, j+1, k+1) ) ;</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> h_windspeed2r = std::sqrt(ux2r * ux2r + uy2r * uy2r);</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160; </div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;                    <span class="comment">// MOST</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> theta_xface = (0.5 * (cell_data(i,j,k  ,<a class="code" href="ERF__IndexDefines_8H.html#a28f96fd04e1ff08fa7a8f53ccde0f877">RhoTheta_comp</a>) + cell_data(i-1,j,k, <a class="code" href="ERF__IndexDefines_8H.html#a28f96fd04e1ff08fa7a8f53ccde0f877">RhoTheta_comp</a>))) / rho_xface;</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_xface_below    = 0.5 * ( cell_data(i,j,k-1,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) + cell_data(i-1,j,k-1,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) );</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> theta_xface_below  = (0.5 * (cell_data(i,j,k-1,<a class="code" href="ERF__IndexDefines_8H.html#a28f96fd04e1ff08fa7a8f53ccde0f877">RhoTheta_comp</a>) + cell_data(i-1,j,k-1, <a class="code" href="ERF__IndexDefines_8H.html#a28f96fd04e1ff08fa7a8f53ccde0f877">RhoTheta_comp</a>))) / rho_xface_below;</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> theta_surf         = theta_xface_below;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160; </div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> psi_m = 0.0;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> psi_h = 0.0;</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> ustar = h_windspeed2r * kappa / (std::log(1.5 * dx_z / z0) - psi_m); <span class="comment">// calculated from bottom of cell. Maintains flexibility for different Vf values</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> tflux = (tflux_in != 1e-8) ? tflux_in : -(theta_xface - theta_surf) * ustar * kappa / (std::log(1.5 * dx_z / z0) - psi_h);</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> Olen = (Olen_in != 1e-8)   ? Olen_in  : -ustar * ustar * ustar * theta_xface / (kappa * ggg * tflux + tiny);</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> zeta  = 1.5 * dx_z / Olen;</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160; </div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;                    <span class="comment">// similarity functions</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;                    psi_m          = sfuns.<a class="code" href="structsimilarity__funs.html#a21cb206b0dd78dc2ac7211de8dbcb8d2">calc_psi_m</a>(zeta);</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;                    psi_h          = sfuns.<a class="code" href="structsimilarity__funs.html#a7dcb32f637eab66d2314902d03289bc2">calc_psi_h</a>(zeta);</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;                    ustar = h_windspeed2r * kappa / (std::log(1.5 * dx_z / z0) - psi_m);</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160; </div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;                    <span class="comment">// prevent some unphysical math</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;                    <span class="keywordflow">if</span> (!(ustar &gt; 0.0 &amp;&amp; !std::isnan(ustar))) { ustar = 0.0; }</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;                    <span class="keywordflow">if</span> (!(ustar &lt; 2.0 &amp;&amp; !std::isnan(ustar))) { ustar = 2.0; }</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;                    <span class="keywordflow">if</span> (psi_m &gt; std::log(0.5 * dx_z / z0)) { psi_m = std::log(0.5 * dx_z / z0); }</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160; </div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;                    <span class="comment">// determine target velocity</span></div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uTarget  = ustar / kappa * (std::log(0.5 * dx_z / z0) - psi_m);</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uxTarget = uTarget * ux2r / (tiny + h_windspeed2r);</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> bc_forcing_x = -(uxTarget - ux); <span class="comment">// BC forcing pushes nonrelative velocity toward target velocity</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;                    xmom_src_arr(i, j, k) -= (1-t_blank) * rho_xface * CdM * U_s * bc_forcing_x; <span class="comment">// if Vf low, force more strongly to MOST. If high, less forcing.</span></div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;                    xmom_src_arr(i, j, k) -= t_blank * rho_xface * CdM * ux * windspeed;</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;                }</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;            });</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;            ParallelFor(tby, [=] AMREX_GPU_DEVICE(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) noexcept</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;            {</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> ux = 0.25 * ( u(i  , j  , k  ) + u(i  , j-1, k  )</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                                       + u(i+1, j  , k  ) + u(i+1, j-1, k  ) );</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uy = v(i, j, k);</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uz = 0.25 * ( w(i  , j  , k  ) + w(i  , j-1, k  )</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;                                       + w(i  , j  , k+1) + w(i  , j-1, k+1) );</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> windspeed = std::sqrt(ux * ux + uy * uy + uz * uz);</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> t_blank = 0.5 * (t_blank_arr(i, j, k) + t_blank_arr(i, j-1, k));</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> t_blank_above = 0.5 * (t_blank_arr(i, j, k+1) + t_blank_arr(i, j-1, k+1));</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> CdM = std::min(drag_coefficient / (windspeed + tiny), 1000.0);</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_yface =  0.5 * ( cell_data(i,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) + cell_data(i,j-1,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) );</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160; </div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;                <span class="keywordflow">if</span> ((t_blank &gt; 0 &amp;&amp; (t_blank_above == 0.0)) &amp;&amp; l_use_most) { <span class="comment">// force to MOST value</span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;                    <span class="comment">// calculate tangential velocity one cell above</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> ux2r = 0.25 * ( u(i  , j  , k+1) + u(i  , j-1, k+1)</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;                                       + u(i+1, j  , k+1) + u(i+1, j-1, k+1) );</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uy2r = v(i, j, k+1) ;</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> h_windspeed2r = std::sqrt(ux2r * ux2r + uy2r * uy2r);</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160; </div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;                    <span class="comment">// MOST</span></div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> theta_yface = (0.5 * (cell_data(i,j,k  ,<a class="code" href="ERF__IndexDefines_8H.html#a28f96fd04e1ff08fa7a8f53ccde0f877">RhoTheta_comp</a>) + cell_data(i,j-1,k, <a class="code" href="ERF__IndexDefines_8H.html#a28f96fd04e1ff08fa7a8f53ccde0f877">RhoTheta_comp</a>))) / rho_yface;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_yface_below    =  0.5 * ( cell_data(i,j,k-1,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) + cell_data(i,j-1,k-1,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) );</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> theta_yface_below  = (0.5 * (cell_data(i,j,k-1,<a class="code" href="ERF__IndexDefines_8H.html#a28f96fd04e1ff08fa7a8f53ccde0f877">RhoTheta_comp</a>) + cell_data(i,j-1,k-1, <a class="code" href="ERF__IndexDefines_8H.html#a28f96fd04e1ff08fa7a8f53ccde0f877">RhoTheta_comp</a>))) / rho_yface_below;</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> theta_surf         = theta_yface_below;</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160; </div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> psi_m = 0.0;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> psi_h = 0.0;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> ustar = h_windspeed2r * kappa / (std::log(1.5 * dx_z / z0) - psi_m); <span class="comment">// calculated from bottom of cell. Maintains flexibility for different Vf values</span></div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> tflux = (tflux_in != 1e-8) ? tflux_in : -(theta_yface - theta_surf) * ustar * kappa / (std::log(1.5 * dx_z / z0) - psi_h);</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> Olen = (Olen_in != 1e-8)   ? Olen_in  : -ustar * ustar * ustar * theta_yface / (kappa * ggg * tflux + tiny);</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> zeta  = 1.5 * dx_z / Olen;</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160; </div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;                    <span class="comment">// similarity functions</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;                    psi_m          = sfuns.<a class="code" href="structsimilarity__funs.html#a21cb206b0dd78dc2ac7211de8dbcb8d2">calc_psi_m</a>(zeta);</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;                    psi_h          = sfuns.<a class="code" href="structsimilarity__funs.html#a7dcb32f637eab66d2314902d03289bc2">calc_psi_h</a>(zeta);</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;                    ustar = h_windspeed2r * kappa / (std::log(1.5 * dx_z / z0) - psi_m);</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160; </div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;                    <span class="comment">// prevent some unphysical math</span></div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;                    <span class="keywordflow">if</span> (!(ustar &gt; 0.0 &amp;&amp; !std::isnan(ustar))) { ustar = 0.0; }</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;                    <span class="keywordflow">if</span> (!(ustar &lt; 2.0 &amp;&amp; !std::isnan(ustar))) { ustar = 2.0; }</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;                    <span class="keywordflow">if</span> (psi_m &gt; std::log(0.5 * dx_z / z0)) { psi_m = std::log(0.5 * dx_z / z0); }</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160; </div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;                    <span class="comment">// determine target velocity</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uTarget  = ustar / kappa * (std::log(0.5 * dx_z / z0) - psi_m);</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uyTarget = uTarget * uy2r / (tiny + h_windspeed2r);</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;                    <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> bc_forcing_y = -(uyTarget - uy);  <span class="comment">// BC forcing pushes nonrelative velocity toward target velocity</span></div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;                    ymom_src_arr(i, j, k) -= (1 - t_blank) * rho_yface * CdM * U_s * bc_forcing_y; <span class="comment">// if Vf low, force more strongly to MOST. If high, less forcing.</span></div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;                    ymom_src_arr(i, j, k) -= t_blank * rho_yface * CdM * uy * windspeed;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;                }</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;            });</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;            ParallelFor(tbz, [=] AMREX_GPU_DEVICE(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) noexcept</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;            {</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> ux = 0.25 * ( u(i  , j  , k  ) + u(i+1, j  , k  )</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;                                       + u(i  , j  , k-1) + u(i+1, j  , k-1) );</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uy = 0.25 * ( v(i  , j  , k  ) + v(i  , j+1, k  )</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;                                       + v(i  , j  , k-1) + v(i  , j+1, k-1) );</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> uz = w(i, j, k);</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> windspeed = std::sqrt(ux * ux + uy * uy + uz * uz);</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> t_blank = 0.5 * (t_blank_arr(i, j, k) + t_blank_arr(i, j, k-1));</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> CdM = std::min(drag_coefficient / (windspeed + tiny), 1000.0);</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                <span class="keyword">const</span> <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_zface =  0.5 * ( cell_data(i,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) + cell_data(i,j,k-1,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) );</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;                zmom_src_arr(i, j, k) -= t_blank * rho_zface * CdM * uz * windspeed;</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;            });</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;        }</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160; </div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;        <span class="comment">// 10. Enforce constant mass flux</span></div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;        <span class="keywordflow">if</span> (is_slow_step &amp;&amp; (enforce_massflux_x || enforce_massflux_y)) {</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;            <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> tau_inv = <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a>(1.0) / solverChoice.<a class="code" href="structSolverChoice.html#af1d75b0930bb8676018816f9e331cc7c">const_massflux_tau</a>;</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160; </div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;            ParallelFor(tbx, tby,</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;            [=] AMREX_GPU_DEVICE(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) noexcept {</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;                xmom_src_arr(i, j, k) += tau_inv * (rhoUA_target - rhoUA);</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;            },</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;            [=] AMREX_GPU_DEVICE(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k) noexcept {</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                ymom_src_arr(i, j, k) += tau_inv * (rhoVA_target - rhoVA);</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;            });</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;        }</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160; </div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;        <span class="comment">// 11. Add w-damping</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;        <span class="comment">// *****************************************************************************</span></div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;        <span class="keywordtype">bool</span>        w_damping       = solverChoice.<a class="code" href="structSolverChoice.html#a2b3ba19d702463b82a9277b1d1e15dd5">dampingChoice</a>.<a class="code" href="structDampingChoice.html#a9bda4d7ea737d254f788af345b24f63e">w_damping</a>;</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;        <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">amrex::Real</a> w_damping_coeff = solverChoice.<a class="code" href="structSolverChoice.html#a2b3ba19d702463b82a9277b1d1e15dd5">dampingChoice</a>.<a class="code" href="structDampingChoice.html#a38c0f8bf23e972dd0bf946ada25995ff">w_damping_coeff</a>;</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;        <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">amrex::Real</a> cflw_lim        = solverChoice.<a class="code" href="structSolverChoice.html#a2b3ba19d702463b82a9277b1d1e15dd5">dampingChoice</a>.<a class="code" href="structDampingChoice.html#aafaf1ff2f8a9873528b1f473f007cfd3">w_damping_cfl</a>;</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160; </div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;        <span class="keywordflow">if</span> (w_damping &amp;&amp; is_slow_step) {</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;            ParallelFor(tbz, [=] AMREX_GPU_DEVICE (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k)</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;            {</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;                <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> dzInv;</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;                <span class="keywordflow">if</span> (z_nd_arr) {</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;                    <span class="comment">// average z_nd to face then diff</span></div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;                    <span class="keywordflow">if</span> (k == domain.smallEnd(2)) {</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;                        dzInv = 4.0 / (</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;                            z_nd_arr(i  ,j  ,k+1) - z_nd_arr(i  ,j  ,k)</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;                          + z_nd_arr(i+1,j  ,k+1) - z_nd_arr(i+1,j  ,k)</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;                          + z_nd_arr(i  ,j+1,k+1) - z_nd_arr(i  ,j+1,k)</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;                          + z_nd_arr(i+1,j+1,k+1) - z_nd_arr(i+1,j+1,k) );</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;                    } <span class="keywordflow">else</span> <a class="code" href="ERF__AddQKESources_8H.html#ad212ca7498a026ec3f73cef6a5f29738">if</a> (k == domain.bigEnd(2)+1) {</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;                        dzInv = 4.0 / (</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;                            z_nd_arr(i  ,j  ,k) - z_nd_arr(i  ,j  ,k-1)</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;                          + z_nd_arr(i+1,j  ,k) - z_nd_arr(i+1,j  ,k-1)</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;                          + z_nd_arr(i  ,j+1,k) - z_nd_arr(i  ,j+1,k-1)</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;                          + z_nd_arr(i+1,j+1,k) - z_nd_arr(i+1,j+1,k-1) );</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;                        <span class="comment">// dz = 0.5 * (dz[i,j,k] + dz[i,j,k+1])</span></div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;                        <span class="comment">//    = 0.5 * (z_nd_face[i,j,k+1] - z_nd_face[i,j,k-1])</span></div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;                        dzInv = 8.0 / (</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                            z_nd_arr(i  ,j  ,k+1) - z_nd_arr(i  ,j  ,k-1)</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;                          + z_nd_arr(i+1,j  ,k+1) - z_nd_arr(i+1,j  ,k-1)</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;                          + z_nd_arr(i  ,j+1,k+1) - z_nd_arr(i  ,j+1,k-1)</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;                          + z_nd_arr(i+1,j+1,k+1) - z_nd_arr(i+1,j+1,k-1) );</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;                    }</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;                    dzInv = dxInv[2];</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;                }</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160; </div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;                <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> rho_on_w_face = 0.5 * ( cell_data(i,j,k,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) + cell_data(i,j,k-1,<a class="code" href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a>) );</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;                <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> wmag = std::abs(rho_w(i,j,k) / rho_on_w_face);</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160; </div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;                <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> cflw = wmag * dt * dzInv;</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;                <span class="keywordflow">if</span> (cflw &gt; cflw_lim) {</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;<span class="preprocessor">#ifdef AMREX_USE_GPU</span></div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;                    AMREX_DEVICE_PRINTF(<span class="stringliteral">&quot;w-damping applied at (%d,%d,%d) for w-CFL = %f &gt; %f\n&quot;</span>,</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;                           i,j,k, cflw, cflw_lim);</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;                    printf(<span class="stringliteral">&quot;w-damping applied at (%d,%d,%d) for w-CFL = %f &gt; %f\n&quot;</span>,</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;                           i,j,k, cflw, cflw_lim);</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;                    <a class="code" href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a> sgn_w = (rho_w(i,j,k) &gt; 0) ? 1.0 : -1.0;</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;                    zmom_src_arr(i, j, k) -= rho_on_w_face * sgn_w * w_damping_coeff * (cflw - cflw_lim);</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;                }</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;            });</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        }</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    } <span class="comment">// mfi</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;}</div>
<div class="ttc" id="aERF__AddQKESources_8H_html_ad212ca7498a026ec3f73cef6a5f29738"><div class="ttname"><a href="ERF__AddQKESources_8H.html#ad212ca7498a026ec3f73cef6a5f29738">if</a></div><div class="ttdeci">if(l_use_mynn &amp;&amp;start_comp&lt;=RhoKE_comp &amp;&amp;end_comp &gt;=RhoKE_comp)</div><div class="ttdef"><b>Definition:</b> ERF_AddQKESources.H:2</div></div>
<div class="ttc" id="aERF__ApplyBndryForcing__Forecast_8cpp_html_a44a9506e5ba1a6a6ab085b5d5a0fdd44"><div class="ttname"><a href="ERF__ApplyBndryForcing__Forecast_8cpp.html#a44a9506e5ba1a6a6ab085b5d5a0fdd44">ApplyBndryForcing_Forecast</a></div><div class="ttdeci">void ApplyBndryForcing_Forecast(const SolverChoice &amp;solverChoice, const Geometry geom, const Box &amp;tbx, const Box &amp;tby, const Box &amp;tbz, const Array4&lt; const Real &gt; &amp;z_phys_nd, const Array4&lt; Real &gt; &amp;rho_u_rhs, const Array4&lt; Real &gt; &amp;rho_v_rhs, const Array4&lt; Real &gt; &amp;rho_w_rhs, const Array4&lt; const Real &gt; &amp;rho_u, const Array4&lt; const Real &gt; &amp;rho_v, const Array4&lt; const Real &gt; &amp;rho_w, const Array4&lt; const Real &gt; &amp;rho_u_initial_state, const Array4&lt; const Real &gt; &amp;rho_v_initial_state, const Array4&lt; const Real &gt; &amp;rho_w_initial_state, const Array4&lt; const Real &gt; &amp;cons_initial_state)</div><div class="ttdef"><b>Definition:</b> ERF_ApplyBndryForcing_Forecast.cpp:8</div></div>
<div class="ttc" id="aERF__ApplySpongeZoneBCs_8cpp_html_a0ac83a02df7ee64733226f722e601784"><div class="ttname"><a href="ERF__ApplySpongeZoneBCs_8cpp.html#a0ac83a02df7ee64733226f722e601784">ApplySpongeZoneBCsForMom</a></div><div class="ttdeci">void ApplySpongeZoneBCsForMom(const SpongeChoice &amp;spongeChoice, const Geometry geom, const Box &amp;tbx, const Box &amp;tby, const Box &amp;tbz, const Array4&lt; Real &gt; &amp;rho_u_rhs, const Array4&lt; Real &gt; &amp;rho_v_rhs, const Array4&lt; Real &gt; &amp;rho_w_rhs, const Array4&lt; const Real &gt; &amp;rho_u, const Array4&lt; const Real &gt; &amp;rho_v, const Array4&lt; const Real &gt; &amp;rho_w, const Array4&lt; const Real &gt; &amp;r0, const Array4&lt; const Real &gt; &amp;z_phys_nd, const Array4&lt; const Real &gt; &amp;z_phys_cc)</div><div class="ttdef"><b>Definition:</b> ERF_ApplySpongeZoneBCs.cpp:118</div></div>
<div class="ttc" id="aERF__ApplySpongeZoneBCs__ReadFromFile_8cpp_html_a9bd7c438851be0734e672135ae63d11e"><div class="ttname"><a href="ERF__ApplySpongeZoneBCs__ReadFromFile_8cpp.html#a9bd7c438851be0734e672135ae63d11e">ApplySpongeZoneBCsForMom_ReadFromFile</a></div><div class="ttdeci">void ApplySpongeZoneBCsForMom_ReadFromFile(const SpongeChoice &amp;spongeChoice, const Geometry geom, const Box &amp;tbx, const Box &amp;tby, const Array4&lt; const Real &gt; &amp;cell_data, const Array4&lt; const Real &gt; &amp;z_phys_cc, const Array4&lt; Real &gt; &amp;rho_u_rhs, const Array4&lt; Real &gt; &amp;rho_v_rhs, const Array4&lt; const Real &gt; &amp;rho_u, const Array4&lt; const Real &gt; &amp;rho_v, const Vector&lt; Real * &gt; d_sponge_ptrs_at_lev)</div><div class="ttdef"><b>Definition:</b> ERF_ApplySpongeZoneBCs_ReadFromFile.cpp:8</div></div>
<div class="ttc" id="aERF__Constants_8H_html_a0f51e1ef58cb9a3add46666cc98e6093"><div class="ttname"><a href="ERF__Constants_8H.html#a0f51e1ef58cb9a3add46666cc98e6093">KAPPA</a></div><div class="ttdeci">constexpr amrex::Real KAPPA</div><div class="ttdef"><b>Definition:</b> ERF_Constants.H:20</div></div>
<div class="ttc" id="aERF__Constants_8H_html_a988c4efd6fd0d855e241e77a73191428"><div class="ttname"><a href="ERF__Constants_8H.html#a988c4efd6fd0d855e241e77a73191428">PI</a></div><div class="ttdeci">constexpr amrex::Real PI</div><div class="ttdef"><b>Definition:</b> ERF_Constants.H:6</div></div>
<div class="ttc" id="aERF__Constants_8H_html_ac2d0c304ab1117368778efcda612de43"><div class="ttname"><a href="ERF__Constants_8H.html#ac2d0c304ab1117368778efcda612de43">CONST_GRAV</a></div><div class="ttdeci">constexpr amrex::Real CONST_GRAV</div><div class="ttdef"><b>Definition:</b> ERF_Constants.H:21</div></div>
<div class="ttc" id="aERF__DampingStruct_8H_html_ada1fed43d749500e09ded1d6800449a1a09f7d3b242b6ede7372125e32efaaef1"><div class="ttname"><a href="ERF__DampingStruct_8H.html#ada1fed43d749500e09ded1d6800449a1a09f7d3b242b6ede7372125e32efaaef1">RayleighDampingType::FastExplicit</a></div><div class="ttdeci">@ FastExplicit</div></div>
<div class="ttc" id="aERF__DampingStruct_8H_html_ada1fed43d749500e09ded1d6800449a1af4e9679a52e3d536f79543ab20f3d8c6"><div class="ttname"><a href="ERF__DampingStruct_8H.html#ada1fed43d749500e09ded1d6800449a1af4e9679a52e3d536f79543ab20f3d8c6">RayleighDampingType::FastImplicit</a></div><div class="ttdeci">@ FastImplicit</div></div>
<div class="ttc" id="aERF__DataStruct_8H_html_a3856c8a2f055327ada182186bfd70239a3d2cdf8cea6cb933d4ce759c1ff1b948"><div class="ttname"><a href="ERF__DataStruct_8H.html#a3856c8a2f055327ada182186bfd70239a3d2cdf8cea6cb933d4ce759c1ff1b948">ubar</a></div><div class="ttdeci">@ ubar</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:92</div></div>
<div class="ttc" id="aERF__DataStruct_8H_html_a3856c8a2f055327ada182186bfd70239a3d8bd6001a2421b06c3ec4e9f2dcdffd"><div class="ttname"><a href="ERF__DataStruct_8H.html#a3856c8a2f055327ada182186bfd70239a3d8bd6001a2421b06c3ec4e9f2dcdffd">wbar</a></div><div class="ttdeci">@ wbar</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:92</div></div>
<div class="ttc" id="aERF__DataStruct_8H_html_a3856c8a2f055327ada182186bfd70239acb08c6a1b8bca5e9e4ef6162aef2cfa4"><div class="ttname"><a href="ERF__DataStruct_8H.html#a3856c8a2f055327ada182186bfd70239acb08c6a1b8bca5e9e4ef6162aef2cfa4">vbar</a></div><div class="ttdeci">@ vbar</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:92</div></div>
<div class="ttc" id="aERF__DirectionSelector_8H_html_aca321ed7fddfe43ff7549b4632a3c0d1"><div class="ttname"><a href="ERF__DirectionSelector_8H.html#aca321ed7fddfe43ff7549b4632a3c0d1">ZDir</a></div><div class="ttdeci">DirectionSelector&lt; 2 &gt; ZDir</div><div class="ttdef"><b>Definition:</b> ERF_DirectionSelector.H:38</div></div>
<div class="ttc" id="aERF__IndexDefines_8H_html_a27dcc910aeb002a0fd44727954dc0e49"><div class="ttname"><a href="ERF__IndexDefines_8H.html#a27dcc910aeb002a0fd44727954dc0e49">Rho_comp</a></div><div class="ttdeci">#define Rho_comp</div><div class="ttdef"><b>Definition:</b> ERF_IndexDefines.H:36</div></div>
<div class="ttc" id="aERF__IndexDefines_8H_html_a28f96fd04e1ff08fa7a8f53ccde0f877"><div class="ttname"><a href="ERF__IndexDefines_8H.html#a28f96fd04e1ff08fa7a8f53ccde0f877">RhoTheta_comp</a></div><div class="ttdeci">#define RhoTheta_comp</div><div class="ttdef"><b>Definition:</b> ERF_IndexDefines.H:37</div></div>
<div class="ttc" id="aERF__NumericalDiffusion_8cpp_html_a55bafde70bac8a562579a7ba5c0c53f3"><div class="ttname"><a href="ERF__NumericalDiffusion_8cpp.html#a55bafde70bac8a562579a7ba5c0c53f3">NumericalDiffusion_Ymom</a></div><div class="ttdeci">void NumericalDiffusion_Ymom(const Box &amp;bx, const Real dt, const Real num_diff_coeff, const Array4&lt; const Real &gt; &amp;prim_data, const Array4&lt; const Real &gt; &amp;cell_data, const Array4&lt; Real &gt; &amp;rhs, const Array4&lt; const Real &gt; &amp;mfx_arr, const Array4&lt; const Real &gt; &amp;mfy_arr)</div><div class="ttdef"><b>Definition:</b> ERF_NumericalDiffusion.cpp:151</div></div>
<div class="ttc" id="aERF__NumericalDiffusion_8cpp_html_ac9ebbec8e0b9fe65aca431e66186fb1d"><div class="ttname"><a href="ERF__NumericalDiffusion_8cpp.html#ac9ebbec8e0b9fe65aca431e66186fb1d">NumericalDiffusion_Xmom</a></div><div class="ttdeci">void NumericalDiffusion_Xmom(const Box &amp;bx, const Real dt, const Real num_diff_coeff, const Array4&lt; const Real &gt; &amp;prim_data, const Array4&lt; const Real &gt; &amp;cell_data, const Array4&lt; Real &gt; &amp;rhs, const Array4&lt; const Real &gt; &amp;mfx_arr, const Array4&lt; const Real &gt; &amp;mfy_arr)</div><div class="ttdef"><b>Definition:</b> ERF_NumericalDiffusion.cpp:85</div></div>
<div class="ttc" id="aERF__ReadBndryPlanes_8cpp_html_a63d3125f6fd361f61d697799f46da817"><div class="ttname"><a href="ERF__ReadBndryPlanes_8cpp.html#a63d3125f6fd361f61d697799f46da817">offset</a></div><div class="ttdeci">AMREX_FORCE_INLINE IntVect offset(const int face_dir, const int normal)</div><div class="ttdef"><b>Definition:</b> ERF_ReadBndryPlanes.cpp:28</div></div>
<div class="ttc" id="aERF__ShocInterface_8H_html_ab8a9d2a7cbf2084043f890c3d0a68f57"><div class="ttname"><a href="ERF__ShocInterface_8H.html#ab8a9d2a7cbf2084043f890c3d0a68f57">Real</a></div><div class="ttdeci">amrex::Real Real</div><div class="ttdef"><b>Definition:</b> ERF_ShocInterface.H:19</div></div>
<div class="ttc" id="aclassPlaneAverage_html"><div class="ttname"><a href="classPlaneAverage.html">PlaneAverage</a></div><div class="ttdef"><b>Definition:</b> ERF_PlaneAverage.H:14</div></div>
<div class="ttc" id="anamespaceBaseState_html_a6f8dc3597225ea7941dad615e7f22e91abc888a343d4fcc4fc4ffb79c6ac7cb93"><div class="ttname"><a href="namespaceBaseState.html#a6f8dc3597225ea7941dad615e7f22e91abc888a343d4fcc4fc4ffb79c6ac7cb93">BaseState::r0_comp</a></div><div class="ttdeci">@ r0_comp</div><div class="ttdef"><b>Definition:</b> ERF_IndexDefines.H:63</div></div>
<div class="ttc" id="anamespaceIntVars_html_a52282f730c54deb760c414b54a12a269a2e60798bc45154a8f905b1aa228a24e5"><div class="ttname"><a href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269a2e60798bc45154a8f905b1aa228a24e5">IntVars::ymom</a></div><div class="ttdeci">@ ymom</div><div class="ttdef"><b>Definition:</b> ERF_IndexDefines.H:160</div></div>
<div class="ttc" id="anamespaceIntVars_html_a52282f730c54deb760c414b54a12a269a2e7100afbf5e7a39371f1cb29f6f570a"><div class="ttname"><a href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269a2e7100afbf5e7a39371f1cb29f6f570a">IntVars::cons</a></div><div class="ttdeci">@ cons</div><div class="ttdef"><b>Definition:</b> ERF_IndexDefines.H:158</div></div>
<div class="ttc" id="anamespaceIntVars_html_a52282f730c54deb760c414b54a12a269aaab25f707cae69bfadac2abcd17a2188"><div class="ttname"><a href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269aaab25f707cae69bfadac2abcd17a2188">IntVars::zmom</a></div><div class="ttdeci">@ zmom</div><div class="ttdef"><b>Definition:</b> ERF_IndexDefines.H:161</div></div>
<div class="ttc" id="anamespaceIntVars_html_a52282f730c54deb760c414b54a12a269af661293a5a71ca532c214929b98c0bad"><div class="ttname"><a href="namespaceIntVars.html#a52282f730c54deb760c414b54a12a269af661293a5a71ca532c214929b98c0bad">IntVars::xmom</a></div><div class="ttdeci">@ xmom</div><div class="ttdef"><b>Definition:</b> ERF_IndexDefines.H:159</div></div>
<div class="ttc" id="anamespaceMicVar__Morr_html_aee8eabea0690943ba287c93caab8c1b7a6764e4c83976308b665ab846e77b53b0"><div class="ttname"><a href="namespaceMicVar__Morr.html#aee8eabea0690943ba287c93caab8c1b7a6764e4c83976308b665ab846e77b53b0">MicVar_Morr::nr</a></div><div class="ttdeci">@ nr</div><div class="ttdef"><b>Definition:</b> ERF_Morrison.H:45</div></div>
<div class="ttc" id="anamespaceVars_html_a3e5e550795a0b745a4e43177e81f8c57a2a10a6e726515894b07621908abd4c0c"><div class="ttname"><a href="namespaceVars.html#a3e5e550795a0b745a4e43177e81f8c57a2a10a6e726515894b07621908abd4c0c">Vars::xvel</a></div><div class="ttdeci">@ xvel</div><div class="ttdef"><b>Definition:</b> ERF_IndexDefines.H:141</div></div>
<div class="ttc" id="anamespaceVars_html_a3e5e550795a0b745a4e43177e81f8c57a47abe072e12c61d29cde15a509a0664b"><div class="ttname"><a href="namespaceVars.html#a3e5e550795a0b745a4e43177e81f8c57a47abe072e12c61d29cde15a509a0664b">Vars::cons</a></div><div class="ttdeci">@ cons</div><div class="ttdef"><b>Definition:</b> ERF_IndexDefines.H:140</div></div>
<div class="ttc" id="anamespaceVars_html_a3e5e550795a0b745a4e43177e81f8c57a81793b83204cfa56d4683bc676fbbfb6"><div class="ttname"><a href="namespaceVars.html#a3e5e550795a0b745a4e43177e81f8c57a81793b83204cfa56d4683bc676fbbfb6">Vars::yvel</a></div><div class="ttdeci">@ yvel</div><div class="ttdef"><b>Definition:</b> ERF_IndexDefines.H:142</div></div>
<div class="ttc" id="anamespacemodule__model__constants_html_a8aff14ee510fe368c6991bc969cb5721"><div class="ttname"><a href="namespacemodule__model__constants.html#a8aff14ee510fe368c6991bc969cb5721">module_model_constants::epsilon</a></div><div class="ttdeci">real(c_double), parameter epsilon</div><div class="ttdef"><b>Definition:</b> ERF_module_model_constants.F90:12</div></div>
<div class="ttc" id="astructDampingChoice_html_a02972b3bec5a3b8aa713b50f2324d895"><div class="ttname"><a href="structDampingChoice.html#a02972b3bec5a3b8aa713b50f2324d895">DampingChoice::rayleigh_damp_V</a></div><div class="ttdeci">bool rayleigh_damp_V</div><div class="ttdef"><b>Definition:</b> ERF_DampingStruct.H:74</div></div>
<div class="ttc" id="astructDampingChoice_html_a38c0f8bf23e972dd0bf946ada25995ff"><div class="ttname"><a href="structDampingChoice.html#a38c0f8bf23e972dd0bf946ada25995ff">DampingChoice::w_damping_coeff</a></div><div class="ttdeci">amrex::Real w_damping_coeff</div><div class="ttdef"><b>Definition:</b> ERF_DampingStruct.H:83</div></div>
<div class="ttc" id="astructDampingChoice_html_a4b77c2ff2209611231f61a4f7be26cab"><div class="ttname"><a href="structDampingChoice.html#a4b77c2ff2209611231f61a4f7be26cab">DampingChoice::rayleigh_dampcoef</a></div><div class="ttdeci">amrex::Real rayleigh_dampcoef</div><div class="ttdef"><b>Definition:</b> ERF_DampingStruct.H:77</div></div>
<div class="ttc" id="astructDampingChoice_html_a51caa6f9c76bc7a8ae5426fb3a73b00d"><div class="ttname"><a href="structDampingChoice.html#a51caa6f9c76bc7a8ae5426fb3a73b00d">DampingChoice::rayleigh_damp_W</a></div><div class="ttdeci">bool rayleigh_damp_W</div><div class="ttdef"><b>Definition:</b> ERF_DampingStruct.H:75</div></div>
<div class="ttc" id="astructDampingChoice_html_a5e628d1d8bc5aa5423fc245af38bf38e"><div class="ttname"><a href="structDampingChoice.html#a5e628d1d8bc5aa5423fc245af38bf38e">DampingChoice::rayleigh_damping_type</a></div><div class="ttdeci">RayleighDampingType rayleigh_damping_type</div><div class="ttdef"><b>Definition:</b> ERF_DampingStruct.H:86</div></div>
<div class="ttc" id="astructDampingChoice_html_a816fcd32a74263a78093b4f590c845ee"><div class="ttname"><a href="structDampingChoice.html#a816fcd32a74263a78093b4f590c845ee">DampingChoice::rayleigh_damp_U</a></div><div class="ttdeci">bool rayleigh_damp_U</div><div class="ttdef"><b>Definition:</b> ERF_DampingStruct.H:73</div></div>
<div class="ttc" id="astructDampingChoice_html_a9bda4d7ea737d254f788af345b24f63e"><div class="ttname"><a href="structDampingChoice.html#a9bda4d7ea737d254f788af345b24f63e">DampingChoice::w_damping</a></div><div class="ttdeci">bool w_damping</div><div class="ttdef"><b>Definition:</b> ERF_DampingStruct.H:81</div></div>
<div class="ttc" id="astructDampingChoice_html_aafaf1ff2f8a9873528b1f473f007cfd3"><div class="ttname"><a href="structDampingChoice.html#aafaf1ff2f8a9873528b1f473f007cfd3">DampingChoice::w_damping_cfl</a></div><div class="ttdeci">amrex::Real w_damping_cfl</div><div class="ttdef"><b>Definition:</b> ERF_DampingStruct.H:82</div></div>
<div class="ttc" id="astructInputSoundingData_html_a36f5c3dc9c536d7a6da2f87d67ea6a08"><div class="ttname"><a href="structInputSoundingData.html#a36f5c3dc9c536d7a6da2f87d67ea6a08">InputSoundingData::V_inp_sound_d</a></div><div class="ttdeci">amrex::Vector&lt; amrex::Gpu::DeviceVector&lt; amrex::Real &gt; &gt; V_inp_sound_d</div><div class="ttdef"><b>Definition:</b> ERF_InputSoundingData.H:407</div></div>
<div class="ttc" id="astructInputSoundingData_html_a4f3f4e6859d978e727af01ca625aea1b"><div class="ttname"><a href="structInputSoundingData.html#a4f3f4e6859d978e727af01ca625aea1b">InputSoundingData::input_sounding_time</a></div><div class="ttdeci">amrex::Vector&lt; amrex::Real &gt; input_sounding_time</div><div class="ttdef"><b>Definition:</b> ERF_InputSoundingData.H:394</div></div>
<div class="ttc" id="astructInputSoundingData_html_a5c190ab2ffec63277427ed6c92d4f53f"><div class="ttname"><a href="structInputSoundingData.html#a5c190ab2ffec63277427ed6c92d4f53f">InputSoundingData::tau_nudging</a></div><div class="ttdeci">amrex::Real tau_nudging</div><div class="ttdef"><b>Definition:</b> ERF_InputSoundingData.H:391</div></div>
<div class="ttc" id="astructInputSoundingData_html_ab040f8bf9b86d53f6acda8c10844c20f"><div class="ttname"><a href="structInputSoundingData.html#ab040f8bf9b86d53f6acda8c10844c20f">InputSoundingData::U_inp_sound_d</a></div><div class="ttdeci">amrex::Vector&lt; amrex::Gpu::DeviceVector&lt; amrex::Real &gt; &gt; U_inp_sound_d</div><div class="ttdef"><b>Definition:</b> ERF_InputSoundingData.H:407</div></div>
<div class="ttc" id="astructSolverChoice_html_a1163778ed56af6977001ef4ec55a3da3"><div class="ttname"><a href="structSolverChoice.html#a1163778ed56af6977001ef4ec55a3da3">SolverChoice::coriolis_factor</a></div><div class="ttdeci">amrex::Real coriolis_factor</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:987</div></div>
<div class="ttc" id="astructSolverChoice_html_a1952672901901b0b3a628f2298dc72c2"><div class="ttname"><a href="structSolverChoice.html#a1952672901901b0b3a628f2298dc72c2">SolverChoice::mesh_type</a></div><div class="ttdeci">static MeshType mesh_type</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:905</div></div>
<div class="ttc" id="astructSolverChoice_html_a1a296d36b81b342c5da390a72421c6c6"><div class="ttname"><a href="structSolverChoice.html#a1a296d36b81b342c5da390a72421c6c6">SolverChoice::if_surf_temp_flux</a></div><div class="ttdeci">amrex::Real if_surf_temp_flux</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:965</div></div>
<div class="ttc" id="astructSolverChoice_html_a2b1552473c77cafa7760c84fcff79650"><div class="ttname"><a href="structSolverChoice.html#a2b1552473c77cafa7760c84fcff79650">SolverChoice::if_use_most</a></div><div class="ttdeci">bool if_use_most</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:969</div></div>
<div class="ttc" id="astructSolverChoice_html_a2b3ba19d702463b82a9277b1d1e15dd5"><div class="ttname"><a href="structSolverChoice.html#a2b3ba19d702463b82a9277b1d1e15dd5">SolverChoice::dampingChoice</a></div><div class="ttdeci">DampingChoice dampingChoice</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:915</div></div>
<div class="ttc" id="astructSolverChoice_html_a39ced5a090f246f82bdec3f5d288fcbc"><div class="ttname"><a href="structSolverChoice.html#a39ced5a090f246f82bdec3f5d288fcbc">SolverChoice::const_massflux_v</a></div><div class="ttdeci">amrex::Real const_massflux_v</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:1057</div></div>
<div class="ttc" id="astructSolverChoice_html_a3a2b3ea3da7ce2b79df1b4b8f903f035"><div class="ttname"><a href="structSolverChoice.html#a3a2b3ea3da7ce2b79df1b4b8f903f035">SolverChoice::if_z0</a></div><div class="ttdeci">amrex::Real if_z0</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:964</div></div>
<div class="ttc" id="astructSolverChoice_html_a411fbfea721cd40033e113cf54a8047f"><div class="ttname"><a href="structSolverChoice.html#a411fbfea721cd40033e113cf54a8047f">SolverChoice::cosphi</a></div><div class="ttdeci">amrex::Real cosphi</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:988</div></div>
<div class="ttc" id="astructSolverChoice_html_a5147634b7c1414a7694c59c1b4a88d69"><div class="ttname"><a href="structSolverChoice.html#a5147634b7c1414a7694c59c1b4a88d69">SolverChoice::abl_geo_forcing</a></div><div class="ttdeci">amrex::GpuArray&lt; amrex::Real, AMREX_SPACEDIM &gt; abl_geo_forcing</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:1030</div></div>
<div class="ttc" id="astructSolverChoice_html_a55a99c03ba69de86126f37568875944a"><div class="ttname"><a href="structSolverChoice.html#a55a99c03ba69de86126f37568875944a">SolverChoice::hindcast_lateral_forcing</a></div><div class="ttdeci">bool hindcast_lateral_forcing</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:1066</div></div>
<div class="ttc" id="astructSolverChoice_html_a56b3643c43d3b6f0fa0f24adeee57f33"><div class="ttname"><a href="structSolverChoice.html#a56b3643c43d3b6f0fa0f24adeee57f33">SolverChoice::massflux_klo</a></div><div class="ttdeci">int massflux_klo</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:1061</div></div>
<div class="ttc" id="astructSolverChoice_html_a596f061b796ada0389c81a6125150b6e"><div class="ttname"><a href="structSolverChoice.html#a596f061b796ada0389c81a6125150b6e">SolverChoice::custom_w_subsidence</a></div><div class="ttdeci">bool custom_w_subsidence</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:994</div></div>
<div class="ttc" id="astructSolverChoice_html_a5a9eef80b6339778c29acb7fb87dd9f1"><div class="ttname"><a href="structSolverChoice.html#a5a9eef80b6339778c29acb7fb87dd9f1">SolverChoice::nudging_from_input_sounding</a></div><div class="ttdeci">bool nudging_from_input_sounding</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:1000</div></div>
<div class="ttc" id="astructSolverChoice_html_a6399ecd90040753b8fb3469172910133"><div class="ttname"><a href="structSolverChoice.html#a6399ecd90040753b8fb3469172910133">SolverChoice::immersed_forcing_substep</a></div><div class="ttdeci">bool immersed_forcing_substep</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:957</div></div>
<div class="ttc" id="astructSolverChoice_html_a6426e150ba9c1ba2e14151228bf6ffaf"><div class="ttname"><a href="structSolverChoice.html#a6426e150ba9c1ba2e14151228bf6ffaf">SolverChoice::sinphi</a></div><div class="ttdeci">amrex::Real sinphi</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:989</div></div>
<div class="ttc" id="astructSolverChoice_html_a65faffc1ea490b3934a9df768cfa26f1"><div class="ttname"><a href="structSolverChoice.html#a65faffc1ea490b3934a9df768cfa26f1">SolverChoice::have_geo_wind_profile</a></div><div class="ttdeci">bool have_geo_wind_profile</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:1032</div></div>
<div class="ttc" id="astructSolverChoice_html_a68e4ef883dc13cca7db5a58589f76f25"><div class="ttname"><a href="structSolverChoice.html#a68e4ef883dc13cca7db5a58589f76f25">SolverChoice::const_massflux_u</a></div><div class="ttdeci">amrex::Real const_massflux_u</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:1056</div></div>
<div class="ttc" id="astructSolverChoice_html_a819a44bb3c482bb99471bc07b2da8ff3"><div class="ttname"><a href="structSolverChoice.html#a819a44bb3c482bb99471bc07b2da8ff3">SolverChoice::if_Olen_in</a></div><div class="ttdeci">amrex::Real if_Olen_in</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:968</div></div>
<div class="ttc" id="astructSolverChoice_html_a9e86533aa6df5bf6408d91f0dfd23606"><div class="ttname"><a href="structSolverChoice.html#a9e86533aa6df5bf6408d91f0dfd23606">SolverChoice::use_coriolis</a></div><div class="ttdeci">bool use_coriolis</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:951</div></div>
<div class="ttc" id="astructSolverChoice_html_aa368e98496254e9aaf594ecf0e4e9981"><div class="ttname"><a href="structSolverChoice.html#aa368e98496254e9aaf594ecf0e4e9981">SolverChoice::num_diff_coeff</a></div><div class="ttdeci">amrex::Real num_diff_coeff</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:1016</div></div>
<div class="ttc" id="astructSolverChoice_html_aa54aafe316efc6cf474326d690fb2fbf"><div class="ttname"><a href="structSolverChoice.html#aa54aafe316efc6cf474326d690fb2fbf">SolverChoice::variable_coriolis</a></div><div class="ttdeci">bool variable_coriolis</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:1035</div></div>
<div class="ttc" id="astructSolverChoice_html_aa7c402e8c29a8f8bbc42ad2701f4132a"><div class="ttname"><a href="structSolverChoice.html#aa7c402e8c29a8f8bbc42ad2701f4132a">SolverChoice::if_Cd_momentum</a></div><div class="ttdeci">amrex::Real if_Cd_momentum</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:962</div></div>
<div class="ttc" id="astructSolverChoice_html_aae4f377d36d01b85a1f322c45009ac75"><div class="ttname"><a href="structSolverChoice.html#aae4f377d36d01b85a1f322c45009ac75">SolverChoice::custom_forcing_prim_vars</a></div><div class="ttdeci">bool custom_forcing_prim_vars</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:996</div></div>
<div class="ttc" id="astructSolverChoice_html_ab734eb0a5147b93dc6590038b6decc60"><div class="ttname"><a href="structSolverChoice.html#ab734eb0a5147b93dc6590038b6decc60">SolverChoice::terrain_type</a></div><div class="ttdeci">static TerrainType terrain_type</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:896</div></div>
<div class="ttc" id="astructSolverChoice_html_ac066852f06a6409e1638f59868b7c57d"><div class="ttname"><a href="structSolverChoice.html#ac066852f06a6409e1638f59868b7c57d">SolverChoice::spongeChoice</a></div><div class="ttdeci">SpongeChoice spongeChoice</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:916</div></div>
<div class="ttc" id="astructSolverChoice_html_ac1ddc9c301ac98689bf3b7b7184b24e1"><div class="ttname"><a href="structSolverChoice.html#ac1ddc9c301ac98689bf3b7b7184b24e1">SolverChoice::init_type</a></div><div class="ttdeci">static InitType init_type</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:890</div></div>
<div class="ttc" id="astructSolverChoice_html_ae2c963893d0c53465ac84c0bd8998a38"><div class="ttname"><a href="structSolverChoice.html#ae2c963893d0c53465ac84c0bd8998a38">SolverChoice::has_lat_lon</a></div><div class="ttdeci">bool has_lat_lon</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:1034</div></div>
<div class="ttc" id="astructSolverChoice_html_aed9118172b234c3a0069a78776d09baa"><div class="ttname"><a href="structSolverChoice.html#aed9118172b234c3a0069a78776d09baa">SolverChoice::do_forest_drag</a></div><div class="ttdeci">bool do_forest_drag</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:1053</div></div>
<div class="ttc" id="astructSolverChoice_html_af1d75b0930bb8676018816f9e331cc7c"><div class="ttname"><a href="structSolverChoice.html#af1d75b0930bb8676018816f9e331cc7c">SolverChoice::const_massflux_tau</a></div><div class="ttdeci">amrex::Real const_massflux_tau</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:1058</div></div>
<div class="ttc" id="astructSolverChoice_html_af2ce02ea291687a31fdd716e2732acfa"><div class="ttname"><a href="structSolverChoice.html#af2ce02ea291687a31fdd716e2732acfa">SolverChoice::massflux_khi</a></div><div class="ttdeci">int massflux_khi</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:1062</div></div>
<div class="ttc" id="astructSolverChoice_html_af4e32876ca1a7d566f5cbe7f083f5a58"><div class="ttname"><a href="structSolverChoice.html#af4e32876ca1a7d566f5cbe7f083f5a58">SolverChoice::forest_substep</a></div><div class="ttdeci">bool forest_substep</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:958</div></div>
<div class="ttc" id="astructSolverChoice_html_afdd906d035384fd962efab24e7a6da7c"><div class="ttname"><a href="structSolverChoice.html#afdd906d035384fd962efab24e7a6da7c">SolverChoice::ave_plane</a></div><div class="ttdeci">int ave_plane</div><div class="ttdef"><b>Definition:</b> ERF_DataStruct.H:1037</div></div>
<div class="ttc" id="astructSpongeChoice_html_a1a41f754595d713df32583f0b0fa606e"><div class="ttname"><a href="structSpongeChoice.html#a1a41f754595d713df32583f0b0fa606e">SpongeChoice::sponge_type</a></div><div class="ttdeci">std::string sponge_type</div><div class="ttdef"><b>Definition:</b> ERF_SpongeStruct.H:58</div></div>
<div class="ttc" id="astructsimilarity__funs_html"><div class="ttname"><a href="structsimilarity__funs.html">similarity_funs</a></div><div class="ttdef"><b>Definition:</b> ERF_MOSTStress.H:41</div></div>
<div class="ttc" id="astructsimilarity__funs_html_a21cb206b0dd78dc2ac7211de8dbcb8d2"><div class="ttname"><a href="structsimilarity__funs.html#a21cb206b0dd78dc2ac7211de8dbcb8d2">similarity_funs::calc_psi_m</a></div><div class="ttdeci">AMREX_GPU_HOST_DEVICE AMREX_FORCE_INLINE amrex::Real calc_psi_m(amrex::Real zeta) const</div><div class="ttdef"><b>Definition:</b> ERF_MOSTStress.H:91</div></div>
<div class="ttc" id="astructsimilarity__funs_html_a7dcb32f637eab66d2314902d03289bc2"><div class="ttname"><a href="structsimilarity__funs.html#a7dcb32f637eab66d2314902d03289bc2">similarity_funs::calc_psi_h</a></div><div class="ttdeci">AMREX_GPU_HOST_DEVICE AMREX_FORCE_INLINE amrex::Real calc_psi_h(amrex::Real zeta) const</div><div class="ttdef"><b>Definition:</b> ERF_MOSTStress.H:105</div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="ERF__MakeMomSources_8cpp_a4cd65257808dd22bb20701e18a9efdcd_cgraph.png" border="0" usemap="#aERF__MakeMomSources_8cpp_a4cd65257808dd22bb20701e18a9efdcd_cgraph" alt=""/></div>
<map name="aERF__MakeMomSources_8cpp_a4cd65257808dd22bb20701e18a9efdcd_cgraph" id="aERF__MakeMomSources_8cpp_a4cd65257808dd22bb20701e18a9efdcd_cgraph">
<area shape="rect" title=" " alt="" coords="5,369,161,396"/>
<area shape="rect" href="ERF__ApplyBndryForcing__Forecast_8cpp.html#a44a9506e5ba1a6a6ab085b5d5a0fdd44" title=" " alt="" coords="215,5,422,32"/>
<area shape="rect" href="ERF__ApplySpongeZoneBCs_8cpp.html#a0ac83a02df7ee64733226f722e601784" title=" " alt="" coords="209,56,428,83"/>
<area shape="rect" href="ERF__ApplySpongeZoneBCs__ReadFromFile_8cpp.html#a9bd7c438851be0734e672135ae63d11e" title=" " alt="" coords="209,107,428,149"/>
<area shape="rect" href="structsimilarity__funs.html#a7dcb32f637eab66d2314902d03289bc2" title=" " alt="" coords="242,173,395,214"/>
<area shape="rect" href="structsimilarity__funs.html#a21cb206b0dd78dc2ac7211de8dbcb8d2" title=" " alt="" coords="242,238,395,279"/>
<area shape="rect" href="classPlaneAverage.html#a603aee4caf3a370d06bee77fddb0e33e" title=" " alt="" coords="231,303,407,345"/>
<area shape="rect" href="classPlaneAverage.html#a027673d7c6dd35a1b45cd1fa8f2b4cb5" title=" " alt="" coords="245,369,392,396"/>
<area shape="rect" href="ERF__AddQKESources_8H.html#ad212ca7498a026ec3f73cef6a5f29738" title=" " alt="" coords="299,420,338,447"/>
<area shape="rect" href="classPlaneAverage.html#af12478c0cb46a8afc438846f8f24e949" title=" " alt="" coords="247,471,390,513"/>
<area shape="rect" href="classPlaneAverage.html#ab65036a99da90fb854f7dfd33cd700b1" title=" " alt="" coords="228,537,409,564"/>
<area shape="rect" href="ERF__NumericalDiffusion_8cpp.html#ac9ebbec8e0b9fe65aca431e66186fb1d" title=" " alt="" coords="220,588,417,615"/>
<area shape="rect" href="ERF__NumericalDiffusion_8cpp.html#a55bafde70bac8a562579a7ba5c0c53f3" title=" " alt="" coords="221,639,417,665"/>
<area shape="rect" href="ERF__ReadBndryPlanes_8cpp.html#a63d3125f6fd361f61d697799f46da817" title=" " alt="" coords="289,689,348,716"/>
<area shape="rect" href="ERF__PBLModels_8H.html#a0922ff80d8ab66f4e128212fbccf64ec" title=" " alt="" coords="476,420,667,447"/>
<area shape="rect" href="ERF__PBLModels_8H.html#a1deabe90a1d943d577b1e8ce80a6b4b1" title=" " alt="" coords="715,420,944,447"/>
<area shape="rect" href="ERF__MoistUtils_8H.html#ac7f742c2dc11eeb2827422c9c5e32b2c" title=" " alt="" coords="992,420,1083,447"/>
<area shape="rect" href="ERF__MoistUtils_8H.html#a81174ac45d8af790b5a6310c4d1369f6" title=" " alt="" coords="1131,395,1395,421"/>
<area shape="rect" href="ERF__MoistUtils_8H.html#a84e52f9faae4809d31ca76dd95aafa19" title=" " alt="" coords="1197,445,1328,472"/>
<area shape="rect" href="ERF__NumericalDiffusion_8H.html#a2985fd8720853d6b8c663c68744dbd97" title=" " alt="" coords="491,613,652,640"/>
</map>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_74389ed8173ad57b461b9d623a1f3867.html">Source</a></li><li class="navelem"><a class="el" href="dir_7c1c0d2e2a0285e12a54f57a60f809aa.html">SourceTerms</a></li><li class="navelem"><a class="el" href="ERF__MakeMomSources_8cpp.html">ERF_MakeMomSources.cpp</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
